<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GDP History Dashboard</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- jQuery (required for noUiSlider, Chart.js, D3, etc.) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- noUiSlider CSS and JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <!-- Vue 2.x -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- vue-treeselect & its styles -->
    <script src="https://cdn.jsdelivr.net/npm/@riophae/vue-treeselect@0.4.0/dist/vue-treeselect.umd.min.js"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@riophae/vue-treeselect@0.4.0/dist/vue-treeselect.min.css">

    <style>
        /* ---------- Global Reset & Base Styles ---------- */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background: #121212;
            color: #e0e0e0;
            /* Remove top padding since header now includes filters */
            padding-top: 0;
        }

        /* ---------- Integrated Header ---------- */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1100;
            background: linear-gradient(135deg, #1f1f1f, #323232);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            font-family: 'Roboto', sans-serif;
        }

        .header-item {
            padding: 0 10px;
        }

        .header-menu,
        .header-account {
            flex: 0.5;
        }

        .header-headline {
            flex: 1;
            text-align: center;
        }

        .header-yearslider {
            flex: 3;
            text-align: center;
        }

        .header-countryfilter {
            flex: 1;
            text-align: center;
        }

        .burger-icon,
        .account-icon {
            font-size: 24px;
            cursor: pointer;
            color: #e0e0e0;
        }

        header h1 {
            margin: 0;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .filter-label {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            display: block;
            color: #e0e0e0;
        }

        /* ---------- Navigation Sidebar ---------- */
        .sidebar {
            height: 100%;
            width: 250px;
            position: fixed;
            top: 0;
            left: -250px;
            background-color: #1f1f1f;
            overflow-x: hidden;
            transition: left 0.3s ease;
            z-index: 1200;
            padding-top: 60px;
            color: #e0e0e0;
            font-family: 'Roboto', sans-serif;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar .close-sidebar {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #e0e0e0;
        }

        .sidebar .main-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar .main-nav ul li {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar .main-nav ul li a {
            text-decoration: none;
            color: #e0e0e0;
            font-weight: 500;
            display: block;
        }

        .sidebar .main-nav ul li a:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* ---------- Overlay for Sidebar ---------- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1150;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* ---------- Global Blur Overlay (for expanded charts) ---------- */
        .global-blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 1500;
            display: none;
        }

        .global-blur-overlay.active {
            display: block;
        }

        /* ---------- Dashboard Container ---------- */
        .dashboard-container {
            width: 100%;
            margin: 80px auto 20px auto;
            padding: 20px;
        }

        /* ---------- Filter Section Above Grid ---------- */
        .filter-section {
            background: #1f1f1f;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 4px;
            color: #e0e0e0;
            font-size: 0.9em;
        }

        #yearRangeDisplay {
            margin-top: 4px;
            font-size: 0.85em;
            color: #e0e0e0;
        }

        /* ---------- Chart Grids Container ---------- */
        #chartGridsContainer {
            display: flex;
            flex-direction: column;
            gap: 40px;
            padding: 0 20px;
        }

        /* ---------- Charts Grid ---------- */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            padding: 20px;
            background: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
            position: relative;
        }

        .quadrant-chart {
            grid-column: 1 / 2;
            position: relative;
        }

        .line-charts {
            grid-column: 2 / 3;
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            height: 500px;
        }

        /* ---------- Quadrant Chart ---------- */
        #quadrantLeftContainer1,
        [id^="quadrantLeftContainer"] {
            background: #2c2c2c;
            padding: 10px;
            border-radius: 6px;
            box-sizing: border-box;
            position: relative;
        }

        #quadrantDropdownContainer1,
        [id^="quadrantDropdownContainer"] {
            margin-bottom: 10px;
        }

        /* ---------- Line Chart Wrapper ---------- */
        .line-chart-wrapper {
            position: relative;
            background: #2c2c2c;
            padding: 10px 10px 30px 10px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            height: 330px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        .indicatorSelect {
            font-size: 1em;
            padding: 5px 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #1f1f1f;
            color: #e0e0e0;
            border: 1px solid #3d3d3d;
        }

        /* ---------- Add Chart Button Styling ---------- */

        #addChartBtn {
            background: #1f1f1f;
            color: #e0e0e0;
            border: none;
            padding: 10px 20px;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
            transition: background 0.3s ease, transform 0.2s ease;
        }

        #addChartBtn:hover {
            background: #323232;
            transform: scale(1.05);
        }

        /* ---------- Expand Button Styling ---------- */
        .expand-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: #e0e0e0;
            border-radius: 3px;
            padding: 4px 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
            z-index: 10;
        }

        .expand-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        /* When expanded, the container uses fixed positioning */
        .line-chart-wrapper.expanded,
        .quadrant-chart.expanded {
            position: fixed;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            z-index: 9999;
            background: #1e1e1e;
            padding: 20px;
            overflow: auto;
        }

        .line-chart-wrapper.expanded .chart-canvas,
        .quadrant-chart.expanded .quadrant-chart-container {
            width: 100% !important;
            height: 100% !important;
        }

        /* ---------- Global Modal (if needed for bar charts) ---------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1300;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: #1e1e1e;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            color: #e0e0e0;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .line-charts {
                height: auto;
                grid-template-rows: auto;
            }
        }

        /* Override vue‑treeselect text color to black */
        .vue-treeselect__control,
        .vue-treeselect__single-value,
        .vue-treeselect__placeholder,
        .vue-treeselect__multi-value-item,
        .vue-treeselect__option,
        .vue-treeselect__label {
            color: black !important;
        }

        .vue-treeselect__value-remove {
            color: black !important;
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <span class="close-sidebar" id="closeSidebar">&times;</span>
        <nav class="main-nav">
            <ul>
                <li><a href="overview.html">Overview</a></li>
                <li><a href="data.html">Data</a></li>
            </ul>
        </nav>
    </div>
    <!-- Overlay for Sidebar -->
    <div class="overlay" id="overlay"></div>
    <!-- Global Blur Overlay for expanded charts -->
    <div id="globalBlurOverlay" class="global-blur-overlay"></div>

    <!-- Integrated Header -->
    <header class="header">
        <!-- Burger Menu Icon (Left) -->
        <div class="header-item header-menu" style="text-align: left;">
            <i id="burgerIcon" class="burger-icon fas fa-bars"></i>
        </div>
        <!-- Headline -->
        <div class="header-item header-headline" style="text-align: center;">
            <h1>GDP History Dashboard</h1>
        </div>
        <!-- Year Slider -->
        <div class="header-item header-yearslider" style="text-align: center;">
            <label for="yearSlider" class="filter-label">Select Year Range:</label>
            <div id="yearSlider"></div>
            <span id="yearRangeDisplay">Selected Years: 2010 - 2021</span>
        </div>
        <!-- Country Filter -->
        <div class="header-item header-countryfilter" id="vueCountrySelectContainer" style="text-align: center;">
            <label class="filter-label">Select Countries:</label>
            <treeselect v-model="value" :multiple="true" :options="options" placeholder="Select countries" />
        </div>
        <!-- Account Icon (Right) -->
        <div class="header-item header-account" style="text-align: right;">
            <i id="accountIcon" class="account-icon fas fa-user"></i>
        </div>
    </header>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- (The filter section below the header has been removed since its controls are now in the header.) -->

        <!-- Container for Multiple Chart Grids -->
        <div id="chartGridsContainer">
            <!-- Initial Chart Grid (Grid 1) -->
            <div class="charts-grid" id="grid1">
                <!-- Left Column: Quadrant Chart -->
                <div class="quadrant-chart" data-chart-type="quadrant">
                    <div id="quadrantLeftContainer1" style="position: relative;">
                        <!-- Expand button for quadrant chart -->
                        <button class="expand-btn" title="Expand Chart">⛶</button>
                        <div id="quadrantDropdownContainer1">
                            <div>
                                <label for="xIndicatorSelect1">X-Axis Indicator:</label>
                                <select id="xIndicatorSelect1"></select>
                            </div>
                            <div>
                                <label for="yIndicatorSelect1">Y-Axis Indicator:</label>
                                <select id="yIndicatorSelect1"></select>
                            </div>
                        </div>
                        <div id="quadrantChartContainer1" style="height:600px;"></div>
                    </div>
                    <div id="quadrantControlContainer1">
                        <button id="quadrantPlayButton1">&#9658;</button>
                        <div id="quadrantYearScale1">
                            <div id="yearMarker1">-</div>
                        </div>
                    </div>
                </div>
                <!-- Right Column: Line Charts -->
                <div class="line-charts" id="chartsContainer1">
                    <!-- Line charts will be dynamically added here -->
                </div>
            </div>
        </div>
        <!-- Add Chart Grid Button -->
        <button id="addChartBtn">Add Chart Grid</button>
    </div>

    <!-- (Optional) Modal for expanded bar charts if needed -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <!-- Expanded chart element will be appended here -->
        </div>
    </div>

    <!-- Tooltip element -->
    <div id="tooltip"></div>

    <!-- Sidebar Toggle Script -->
    <script>
        const burgerIcon = document.getElementById('burgerIcon');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const closeSidebar = document.getElementById('closeSidebar');

        burgerIcon.addEventListener('click', () => {
            sidebar.classList.add('active');
            overlay.classList.add('active');
        });
        closeSidebar.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
        const accountIcon = document.getElementById('accountIcon');
        accountIcon.addEventListener('click', () => {
            window.location.href = "account.html";
        });
    </script>

    <!-- Dashboard & Charts Script -->
    <script>
        let countriesData = [];
        // Set initial year range – this variable will be updated by the slider.
        let yearRange = [2010, 2021];
        const margin = { top: 20, right: 20, bottom: 40, left: 40 };
        const indicators = [
            { value: "NY.GDP.MKTP.CD", text: "GDP (Current US$)" },
            { value: "NY.GDP.PCAP.CD", text: "GDP per Capita (Current US$)" },
            { value: "NY.GDP.MKTP.KD.ZG", text: "GDP Growth (Annual %)" },
            { value: "SP.POP.TOTL", text: "Population, Total" },
            { value: "SL.UEM.TOTL.ZS", text: "Unemployment (% of labor force)" },
            { value: "EN.ATM.CO2E.PC", text: "CO₂ Emissions (Metric tons per capita)" },
            { value: "FP.CPI.TOTL.ZG", text: "Inflation, Consumer Prices (Annual %)" },
            { value: "NE.EXP.GNFS.CD", text: "Exports of Goods and Services (Current US$)" },
            { value: "NE.IMP.GNFS.CD", text: "Imports of Goods and Services (Current US$)" },
            { value: "IT.CEL.SETS.P2", text: "Mobile Cellular Subscriptions (per 100 people)" },
            { value: "EG.ELC.ACCS.ZS", text: "Access to Electricity (% of Population)" },
            { value: "SE.XPD.TOTL.GD.ZS", text: "Government Expenditure on Education (% of GDP)" },
            { value: "SI.POV.DDAY", text: "Poverty Headcount Ratio at $1.90/day" }
        ];
        const indicatorMetadata = {
            "NY.GDP.MKTP.CD": { unit: "USD", formatter: value => "$" + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value) },
            "NY.GDP.PCAP.CD": { unit: "USD", formatter: value => "$" + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value) },
            "NY.GDP.MKTP.KD.ZG": { unit: "%", formatter: value => d3.format(".1f")(value) + '%' },
            "SP.POP.TOTL": { unit: "", formatter: value => new Intl.NumberFormat().format(value) },
            "SL.UEM.TOTL.ZS": { unit: "%", formatter: value => d3.format(".1f")(value) + '%' },
            "EN.ATM.CO2E.PC": { unit: "", formatter: value => new Intl.NumberFormat().format(value) },
            "FP.CPI.TOTL.ZG": { unit: "%", formatter: value => d3.format(".1f")(value) + '%' },
            "NE.EXP.GNFS.CD": { unit: "USD", formatter: value => "$" + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value) },
            "NE.IMP.GNFS.CD": { unit: "USD", formatter: value => "$" + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value) },
            "IT.CEL.SETS.P2": { unit: "", formatter: value => new Intl.NumberFormat().format(value) },
            "EG.ELC.ACCS.ZS": { unit: "%", formatter: value => d3.format(".1f")(value) + '%' },
            "SE.XPD.TOTL.GD.ZS": { unit: "%", formatter: value => d3.format(".1f")(value) + '%' },
            "SI.POV.DDAY": { unit: "", formatter: value => new Intl.NumberFormat().format(value) }
        };
        const abbreviatedFormatter = d3.format(".2s");
        function getFormattedTick(value, indicator) {
            if (value === null || value === undefined || isNaN(value)) return "0";
            const meta = indicatorMetadata[indicator];
            if (meta) {
                if (meta.unit === '%') return d3.format(".1f")(value) + '%';
                else if (meta.unit === 'USD') {
                    if (Math.abs(value) >= 1e12) return d3.format("$,.2s")(value);
                    return "$" + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value);
                } else {
                    if (Math.abs(value) >= 1000) return abbreviatedFormatter(value);
                    return value;
                }
            }
            return value;
        }
        const defaultXIndicator = "NY.GDP.PCAP.CD";
        const defaultYIndicator = "NY.GDP.MKTP.CD";
        const chartInstances = {};
        let nextChartId = 0;
        const flagPlugin = {
            id: 'flagPlugin',
            afterDatasetsDraw(chart, args, options) {
                const { ctx } = chart;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden && meta.data.length > 0 && dataset.flagUrl) {
                        const lastPoint = meta.data[meta.data.length - 1];
                        const img = new Image();
                        img.src = dataset.flagUrl;
                        img.onload = function () {
                            const imgWidth = 50;
                            const imgHeight = 30;
                            ctx.drawImage(img, lastPoint.x + 5, lastPoint.y - imgHeight / 2, imgWidth, imgHeight);
                        };
                    }
                });
            }
        };
        function getRandomColor(opacity = 1) {
            const r = Math.floor(Math.random() * 156) + 100;
            const g = Math.floor(Math.random() * 156) + 100;
            const b = Math.floor(Math.random() * 156) + 100;
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        function filterDataByYears(data, startYear, endYear) {
            const filtered = { years: [], values: [] };
            for (let i = 0; i < data.years.length; i++) {
                const yr = parseInt(data.years[i]);
                if (yr >= startYear && yr <= endYear) {
                    filtered.years.push(data.years[i]);
                    filtered.values.push(data.values[i]);
                }
            }
            return filtered;
        }
        async function fetchIndicatorData(country, indicator) {
            const url = `https://api.worldbank.org/v2/country/${country}/indicator/${indicator}?format=json&per_page=1000`;
            try {
                const response = await fetch(url);
                const json = await response.json();
                if (!json || json.length < 2) return { years: [], values: [] };
                const rawData = json[1].filter(d => d.value !== null);
                rawData.sort((a, b) => parseInt(a.date) - parseInt(b.date));
                const years = rawData.map(d => d.date);
                const values = rawData.map(d => d.value);
                return { years, values };
            } catch (error) {
                console.error("Error fetching data for", country, error);
                return { years: [], values: [] };
            }
        }
        async function getChartDataForIndicator(indicator) {
            const selectedCountries = window.selectedCountries;
            if (!selectedCountries || selectedCountries.length === 0) {
                return { chartLabels: [], datasets: [] };
            }
            const datasets = await Promise.all(selectedCountries.map(async (countryIso3) => {
                const countryObj = countriesData.find(c => c.id === countryIso3) ||
                    { name: countryIso3, iso2Code: countryIso3.substring(0, 2).toLowerCase() };
                const flagUrl = `https://flagcdn.com/w80/${countryObj.iso2Code.toLowerCase()}.png`;
                const completeData = await fetchIndicatorData(countryIso3, indicator);
                const filteredData = filterDataByYears(completeData, yearRange[0], yearRange[1]);
                return {
                    label: countryObj.name,
                    data: filteredData.values,
                    borderColor: getRandomColor(1),
                    backgroundColor: getRandomColor(0.2),
                    fill: true,
                    tension: 0.1,
                    flagUrl: flagUrl,
                    years: filteredData.years
                };
            }));
            const chartLabels = datasets.length > 0 ? datasets[0].years : [];
            return { chartLabels, datasets };
        }

        async function updateChartInstance(chartObj, containerId) {
            const indicator = chartObj.indicatorSelect.value;
            const data = await getChartDataForIndicator(indicator);
            if (!data) return;
            const selectedInd = indicators.find(ind => ind.value === indicator);
            chartObj.chart.options.plugins.title.text = selectedInd ? selectedInd.text : "";
            chartObj.chart.data.labels = data.chartLabels;
            chartObj.chart.data.datasets = data.datasets;
            chartObj.chart.options.scales.y.ticks.callback = function (value) {
                return getFormattedTick(value, indicator);
            };
            chartObj.chart.update();
        }

        async function updateAllCharts() {
            for (const gridId in chartInstances) {
                const instances = chartInstances[gridId];
                for (const chartObj of instances) {
                    await updateChartInstance(chartObj, gridId);
                }
            }
            const gridContainer = document.getElementById("chartGridsContainer");
            const grids = gridContainer.querySelectorAll(".charts-grid");
            grids.forEach((grid) => {
                const gridSuffix = grid.id.replace('grid', '');
                loadQuadrantData(gridSuffix);
            });
        }

        // --- Expand Button Functionality ---
        document.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("expand-btn")) {
                const container = e.target.closest(".line-chart-wrapper, .quadrant-chart");
                const isExpanded = container.classList.contains("expanded");
                container.classList.toggle("expanded");
                e.target.innerHTML = container.classList.contains("expanded") ? "✕" : "⛶";
                const blurOverlay = document.getElementById("globalBlurOverlay");
                if (container.classList.contains("expanded")) {
                    blurOverlay.classList.add("active");
                } else {
                    blurOverlay.classList.remove("active");
                }
                window.dispatchEvent(new Event('resize'));
                if (container.classList.contains("quadrant-chart")) {
                    const quadrantContainer = container.querySelector(".quadrant-chart-container");
                    if (isExpanded) {
                        quadrantContainer.style.width = "100%";
                        quadrantContainer.style.height = "600px";
                    } else {
                        quadrantContainer.style.width = "80%";
                        quadrantContainer.style.height = "80%";
                    }
                }
                if (container.classList.contains("line-chart-wrapper")) {
                    const chartCanvas = container.querySelector(".chart-canvas");
                    if (isExpanded) {
                        chartCanvas.style.width = "100%";
                        chartCanvas.style.height = "100%";
                    } else {
                        chartCanvas.style.width = "80%";
                        chartCanvas.style.height = "80%";
                    }
                }
            }
        });

        function createNewChartInstance(defaultIndicator, containerId) {
            const chartsContainer = document.getElementById(containerId);
            const chartWrapper = document.createElement("div");
            chartWrapper.classList.add("line-chart-wrapper");
            const expandBtn = document.createElement("button");
            expandBtn.className = "expand-btn";
            expandBtn.title = "Expand Chart";
            expandBtn.innerHTML = "⛶";
            chartWrapper.appendChild(expandBtn);
            const indicatorSelect = document.createElement("select");
            indicatorSelect.classList.add("indicatorSelect");
            indicators.forEach(ind => {
                const option = document.createElement("option");
                option.value = ind.value;
                option.textContent = ind.text;
                indicatorSelect.appendChild(option);
            });
            indicatorSelect.value = defaultIndicator || indicators[0].value;
            indicatorSelect.addEventListener("change", () => {
                const instance = chartInstances[containerId].find(obj => obj.indicatorSelect === indicatorSelect);
                if (instance) updateChartInstance(instance, containerId);
            });
            chartWrapper.appendChild(indicatorSelect);
            const canvas = document.createElement("canvas");
            canvas.id = `chartCanvas${nextChartId++}`;
            canvas.classList.add("chart-canvas");
            chartWrapper.appendChild(canvas);
            chartsContainer.appendChild(chartWrapper);
            const ctx = canvas.getContext("2d");
            const newChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { right: 70 } },
                    plugins: { title: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Year' } },
                        y: { title: { display: true, text: 'Value' }, ticks: { callback: value => value } }
                    }
                },
                plugins: [flagPlugin]
            });
            if (!chartInstances[containerId]) chartInstances[containerId] = [];
            chartInstances[containerId].push({ chart: newChart, indicatorSelect: indicatorSelect });
        }

        let quadrantStates = {};
        function getQuadrantState(gridSuffix) {
            if (!quadrantStates[gridSuffix]) {
                quadrantStates[gridSuffix] = {
                    data: [],
                    years: [],
                    currentYearIndex: 0,
                    svgSelection: null,
                    width: 0,
                    height: 0,
                    history: {}
                };
            }
            return quadrantStates[gridSuffix];
        }

        function resetQuadrantChart(gridSuffix) {
            const state = getQuadrantState(gridSuffix);
            const container = document.getElementById("quadrantChartContainer" + gridSuffix);
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            d3.select("#quadrantChartContainer" + gridSuffix).selectAll("*").remove();
            state.svgSelection = d3.select("#quadrantChartContainer" + gridSuffix)
                .append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${margin.top},${margin.left})`);
            state.width = containerWidth - margin.left - margin.right;
            state.height = containerHeight - margin.top - margin.bottom;
        }

        function getSelectedQuadrantIndicators(gridSuffix) {
            const xIndicator = document.getElementById("xIndicatorSelect" + gridSuffix).value;
            const yIndicator = document.getElementById("yIndicatorSelect" + gridSuffix).value;
            return { xIndicator, yIndicator };
        }

        async function loadQuadrantData(gridSuffix) {
            resetQuadrantChart(gridSuffix);
            const state = getQuadrantState(gridSuffix);
            const selectedCountryIds = window.selectedCountries;
            if (!selectedCountryIds || selectedCountryIds.length === 0) return;
            const { xIndicator, yIndicator } = getSelectedQuadrantIndicators(gridSuffix);
            state.data = [];
            await Promise.all(selectedCountryIds.map(async countryId => {
                const countryObj = countriesData.find(c => c.id === countryId) ||
                    { id: countryId, name: countryId, iso2Code: countryId.substring(0, 2).toLowerCase() };
                const xData = await fetchIndicatorData(countryId, xIndicator);
                const yData = await fetchIndicatorData(countryId, yIndicator);
                const xMap = new Map();
                xData.years.forEach((yr, i) => { xMap.set(yr, xData.values[i]); });
                const yMap = new Map();
                yData.years.forEach((yr, i) => { yMap.set(yr, yData.values[i]); });
                const commonYears = xData.years.filter(yr => yMap.has(yr)).sort((a, b) => a - b);
                const filteredYears = commonYears.filter(yr => +yr >= yearRange[0] && +yr <= yearRange[1]);
                const dataPoints = filteredYears.map(yr => ({ year: +yr, x: +xMap.get(yr), y: +yMap.get(yr) }));
                state.data.push({ country: countryObj, data: dataPoints });
            }));
            if (state.data.length > 0) {
                const allYears = state.data.map(d => d.data.map(p => p.year));
                state.years = allYears.reduce((acc, curr) => acc.filter(y => curr.includes(y)));
                state.years.sort((a, b) => a - b);
            }
            state.currentYearIndex = 0;
            state.history = {};
            drawQuadrantChart(gridSuffix);
            updateYearMarker(gridSuffix);
        }

        function drawQuadrantChart(gridSuffix) {
            const state = getQuadrantState(gridSuffix);
            const { xIndicator, yIndicator } = getSelectedQuadrantIndicators(gridSuffix);
            const allPoints = state.data.flatMap(d => d.data);
            const xScale = d3.scaleLinear()
                .domain(d3.extent(allPoints, d => d.x)).nice()
                .range([0, state.width]);
            const yScale = d3.scaleLinear()
                .domain(d3.extent(allPoints, d => d.y)).nice()
                .range([state.height, 0]);
            state.xScale = xScale;
            state.yScale = yScale;
            const xMid = xScale((xScale.domain()[0] + xScale.domain()[1]) / 2);
            const yMid = yScale((yScale.domain()[0] + yScale.domain()[1]) / 2);
            const quadrants = [
                { x: 0, y: 0, width: xMid, height: yMid, fill: "#FFA500" },
                { x: xMid, y: 0, width: state.width - xMid, height: yMid, fill: "#FF0000" },
                { x: 0, y: yMid, width: xMid, height: state.height - yMid, fill: "#1E90FF" },
                { x: xMid, y: yMid, width: state.width - xMid, height: state.height - yMid, fill: "#FFA500" }
            ];
            quadrants.forEach((quadrant) => {
                state.svgSelection.insert("rect", ":first-child")
                    .attr("x", quadrant.x)
                    .attr("y", quadrant.y)
                    .attr("width", quadrant.width)
                    .attr("height", quadrant.height)
                    .attr("fill", quadrant.fill)
                    .attr("opacity", 0.3);
                let iconClass = "";
                if (quadrant.fill === "#FF0000") iconClass = "fas fa-fire";
                else if (quadrant.fill === "#1E90FF") iconClass = "fas fa-snowflake";
                else if (quadrant.fill === "#FFA500") iconClass = "fas fa-adjust";
                const iconWidth = 40, iconHeight = 40;
                state.svgSelection.append("foreignObject")
                    .attr("x", quadrant.x + 5)
                    .attr("y", quadrant.y + quadrant.height - iconHeight - 5)
                    .attr("width", iconWidth)
                    .attr("height", iconHeight)
                    .append("xhtml:div")
                    .html(`<i class="${iconClass}" style="opacity:0.3; font-size:40px; color:#fff;"></i>`);
            });
            state.svgSelection.append("g")
                .attr("class", "axis x-axis")
                .attr("transform", `translate(0,${state.height})`)
                .call(d3.axisBottom(xScale).tickFormat(d => {
                    let formatted = d3.format(".2s")(d);
                    if (indicatorMetadata[xIndicator] && indicatorMetadata[xIndicator].unit === '%') {
                        formatted += '%';
                    }
                    return formatted;
                }));
            state.svgSelection.append("g")
                .attr("class", "axis y-axis")
                .call(d3.axisLeft(yScale).tickFormat(d => {
                    let formatted = d3.format(".2s")(d);
                    if (indicatorMetadata[yIndicator] && indicatorMetadata[yIndicator].unit === '%') {
                        formatted += '%';
                    }
                    return formatted;
                }));
            state.svgSelection.append("line")
                .attr("x1", xScale((xScale.domain()[0] + xScale.domain()[1]) / 2))
                .attr("x2", xScale((xScale.domain()[0] + xScale.domain()[1]) / 2))
                .attr("y1", 0)
                .attr("y2", state.height)
                .attr("stroke", "#ccc")
                .attr("stroke-dasharray", "4,4");
            state.svgSelection.append("line")
                .attr("y1", yScale((yScale.domain()[0] + yScale.domain()[1]) / 2))
                .attr("y2", yScale((yScale.domain()[0] + yScale.domain()[1]) / 2))
                .attr("x1", 0)
                .attr("x2", state.width)
                .attr("stroke", "#ccc")
                .attr("stroke-dasharray", "4,4");
            state.data.forEach(d => {
                state.history[d.country.id] = [];
                const g = state.svgSelection.append("g")
                    .attr("class", "country-group")
                    .attr("id", "group-" + d.country.id + gridSuffix);
                g.append("path")
                    .attr("class", "country-path")
                    .attr("id", "path-" + d.country.id + gridSuffix)
                    .attr("fill", "none")
                    .attr("stroke", getRandomColor(1))
                    .attr("stroke-width", 2);
                g.append("circle")
                    .attr("class", "country-circle")
                    .attr("id", "circle-" + d.country.id + gridSuffix)
                    .attr("r", 5)
                    .attr("fill", getRandomColor(1));
            });
        }

        function updateQuadrantChart(gridSuffix) {
            const state = getQuadrantState(gridSuffix);
            if (state.currentYearIndex >= state.years.length) return;
            const year = state.years[state.currentYearIndex];
            const { xIndicator, yIndicator } = getSelectedQuadrantIndicators(gridSuffix);
            state.data.forEach(d => {
                const datum = d.data.find(p => p.year === year);
                if (datum) {
                    state.history[d.country.id].push(datum);
                    const circleSelection = d3.select("#circle-" + d.country.id + gridSuffix);
                    circleSelection
                        .on("mouseover", function (event) {
                            d3.select("#tooltip").style("opacity", 1)
                                .html(`Year: ${datum.year}<br>${xIndicator}: ${datum.x}<br>${yIndicator}: ${datum.y}`);
                        })
                        .on("mousemove", function (event) {
                            d3.select("#tooltip").style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY + 10) + "px");
                        })
                        .on("mouseout", function () {
                            d3.select("#tooltip").style("opacity", 0);
                        })
                        .transition()
                        .duration(500)
                        .attr("cx", state.xScale(datum.x))
                        .attr("cy", state.yScale(datum.y))
                        .on("end", function () {
                            d3.select(this.parentNode).select("image").remove();
                            const flagImg = d3.select(this.parentNode)
                                .append("svg:image")
                                .attr("xlink:href", `https://flagcdn.com/w80/${d.country.iso2Code.toLowerCase()}.png`)
                                .attr("width", 40)
                                .attr("height", 25)
                                .attr("x", state.xScale(datum.x) + 8)
                                .attr("y", state.yScale(datum.y) - 12);
                            flagImg
                                .on("mouseover", function (event) {
                                    d3.select("#tooltip").style("opacity", 1)
                                        .html(`Year: ${datum.year}<br>${xIndicator}: ${datum.x}<br>${yIndicator}: ${datum.y}`);
                                })
                                .on("mousemove", function (event) {
                                    d3.select("#tooltip").style("left", (event.pageX + 10) + "px")
                                        .style("top", (event.pageY + 10) + "px");
                                })
                                .on("mouseout", function () {
                                    d3.select("#tooltip").style("opacity", 0);
                                });
                        });
                    const lineGenerator = d3.line()
                        .x(d => state.xScale(d.x))
                        .y(d => state.yScale(d.y));
                    d3.select("#path-" + d.country.id + gridSuffix)
                        .attr("d", lineGenerator(state.history[d.country.id]));
                }
            });
            updateYearMarker(gridSuffix);
        }

        function updateYearMarker(gridSuffix) {
            const state = getQuadrantState(gridSuffix);
            if (state.years.length === 0) return;
            const year = state.currentYearIndex < state.years.length ? state.years[state.currentYearIndex] : state.years[state.years.length - 1];
            const marker = document.getElementById("yearMarker" + gridSuffix);
            marker.textContent = year;
            const scaleContainer = document.getElementById("quadrantYearScale" + gridSuffix);
            const containerWidth = scaleContainer.clientWidth;
            const markerWidth = marker.clientWidth;
            const minYear = state.years[0];
            const maxYear = state.years[state.years.length - 1];
            const pos = ((year - minYear) / (maxYear - minYear)) * (containerWidth - markerWidth);
            marker.style.left = pos + "px";
        }

        function playQuadrantChart(gridSuffix) {
            const state = getQuadrantState(gridSuffix);
            state.currentYearIndex = 0;
            state.data.forEach(d => {
                state.history[d.country.id] = [];
                d3.select("#path-" + d.country.id + gridSuffix).attr("d", null);
                d3.select("#circle-" + d.country.id + gridSuffix)
                    .attr("cx", null)
                    .attr("cy", null);
                d3.select("#group-" + d.country.id + gridSuffix).selectAll("image").remove();
            });
            updateYearMarker(gridSuffix);
            const interval = d3.interval(() => {
                if (state.currentYearIndex >= state.years.length) {
                    interval.stop();
                    return;
                }
                updateQuadrantChart(gridSuffix);
                state.currentYearIndex++;
            }, 500);
        }

        function populateQuadrantIndicatorDropdownsForGrid(gridSuffix) {
            const xSelect = document.getElementById("xIndicatorSelect" + gridSuffix);
            const ySelect = document.getElementById("yIndicatorSelect" + gridSuffix);
            indicators.forEach(ind => {
                const optX = document.createElement("option");
                optX.value = ind.value;
                optX.textContent = ind.text;
                xSelect.appendChild(optX);
                const optY = document.createElement("option");
                optY.value = ind.value;
                optY.textContent = ind.text;
                ySelect.appendChild(optY);
            });
            xSelect.value = defaultXIndicator;
            ySelect.value = defaultYIndicator;
            xSelect.addEventListener("change", () => { loadQuadrantData(gridSuffix); });
            ySelect.addEventListener("change", () => { loadQuadrantData(gridSuffix); });
        }

        function createNewChartGrid() {
            const gridContainer = document.getElementById("chartGridsContainer");
            const gridCount = gridContainer.querySelectorAll('.charts-grid').length + 1;
            const newGrid = document.createElement("div");
            newGrid.className = "charts-grid";
            newGrid.id = `grid${gridCount}`;
            const quadrantDiv = document.createElement("div");
            quadrantDiv.className = "quadrant-chart";
            quadrantDiv.setAttribute("data-chart-type", "quadrant");
            quadrantDiv.innerHTML = `
        <div id="quadrantLeftContainer${gridCount}" style="position: relative;">
          <button class="expand-btn" title="Expand Chart">⛶</button>
          <div id="quadrantDropdownContainer${gridCount}">
            <div>
              <label for="xIndicatorSelect${gridCount}">X-Axis Indicator:</label>
              <select id="xIndicatorSelect${gridCount}"></select>
            </div>
            <div>
              <label for="yIndicatorSelect${gridCount}">Y-Axis Indicator:</label>
              <select id="yIndicatorSelect${gridCount}"></select>
            </div>
          </div>
          <div id="quadrantChartContainer${gridCount}" style="height:600px;"></div>
        </div>
        <div id="quadrantControlContainer${gridCount}">
          <button id="quadrantPlayButton${gridCount}">&#9658;</button>
          <div id="quadrantYearScale${gridCount}">
            <div id="yearMarker${gridCount}">-</div>
          </div>
        </div>
      `;
            const lineChartsDiv = document.createElement("div");
            lineChartsDiv.className = "line-charts";
            lineChartsDiv.id = `chartsContainer${gridCount}`;
            lineChartsDiv.innerHTML = `<!-- Line charts will be dynamically added here -->`;
            newGrid.appendChild(quadrantDiv);
            newGrid.appendChild(lineChartsDiv);
            gridContainer.appendChild(newGrid);
            populateQuadrantIndicatorDropdownsForGrid(gridCount);
            document.getElementById("quadrantPlayButton" + gridCount).addEventListener("click", () => {
                playQuadrantChart(gridCount);
            });
            createNewChartInstance(defaultXIndicator, `chartsContainer${gridCount}`);
            createNewChartInstance(defaultYIndicator, `chartsContainer${gridCount}`);
            loadQuadrantData(gridCount);
        }

        document.getElementById("addChartBtn").addEventListener("click", () => {
            createNewChartGrid();
            updateAllCharts();
        });

        document.addEventListener("DOMContentLoaded", async () => {
            populateQuadrantIndicatorDropdownsForGrid(1);
            document.getElementById("quadrantPlayButton1").addEventListener("click", () => {
                playQuadrantChart(1);
            });
            createNewChartInstance(defaultXIndicator, "chartsContainer1");
            createNewChartInstance(defaultYIndicator, "chartsContainer1");
        });
    </script>

    <!-- Initialize the noUiSlider for Year Range Selection -->
    <script>
        const yearSlider = document.getElementById("yearSlider");
        noUiSlider.create(yearSlider, {
            start: yearRange,
            connect: true,
            step: 1,
            range: {
                min: 1960,
                max: 2023
            },
            format: {
                to: value => Math.round(value),
                from: value => Number(value)
            }
        });
        yearSlider.noUiSlider.on('update', function (values) {
            yearRange = values.map(Number);
            document.getElementById("yearRangeDisplay").textContent = "Selected Years: " + yearRange[0] + " - " + yearRange[1];
        });
        yearSlider.noUiSlider.on('change', function () {
            updateAllCharts();
        });
    </script>

    <!-- Vue Treeselect Instance for Country Selection -->
    <script>
        Vue.component('treeselect', VueTreeselect.Treeselect);
        new Vue({
            el: '#vueCountrySelectContainer',
            data: {
                value: [],
                options: [],
                regionMapping: {}
            },
            watch: {
                value(newVal) {
                    let selectedIds = [];
                    newVal.forEach(val => {
                        if (countriesData.find(country => country.id === val)) {
                            selectedIds.push(val);
                        } else if (this.regionMapping[val]) {
                            selectedIds = selectedIds.concat(this.regionMapping[val].map(country => country.id));
                        }
                    });
                    window.selectedCountries = selectedIds;
                    updateAllCharts();
                }
            },
            created() {
                fetch("countries.json")
                    .then(response => response.json())
                    .then(countries => {
                        countriesData = countries;
                        const regionsMap = {};
                        countries.forEach(country => {
                            let regionName = country.region.value.trim();
                            if (!regionName) return;
                            if (!regionsMap[regionName]) {
                                regionsMap[regionName] = [];
                            }
                            regionsMap[regionName].push({
                                id: country.id,
                                label: country.name
                            });
                        });
                        this.regionMapping = regionsMap;
                        this.options = Object.keys(regionsMap).map(region => ({
                            id: region,
                            label: region,
                            children: regionsMap[region]
                        }));
                        this.value = ["USA"];
                        window.selectedCountries = this.value;
                        updateAllCharts();
                    })
                    .catch(error => {
                        console.error("Error loading countries.json:", error);
                    });
            }
        });
    </script>
</body>

</html>