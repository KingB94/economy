<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Economic Data Dashboard</title>
  <!-- Google Fonts for professional typography -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <!-- Select2 JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <!-- Chart.js and ChartDataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- UiSlider CSS and JS -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <!-- D3.js and TopoJSON -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <!-- Vue 2 and Vue Treeselect -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@riophae/vue-treeselect@0.4.0/dist/vue-treeselect.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@riophae/vue-treeselect@0.4.0/dist/vue-treeselect.min.css">
  <!-- Font Awesome CSS for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- PptcGenJS and html2canvas-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script defer src="https://unpkg.com/pptxgenjs/dist/pptxgen.bundle.js"></script>
  <style>
    :root {
      /* Color Palette */
      --color-bg: #1a1a1a;
      --color-bg-light: #1a1a1a;
      --color-bg-medium: #333333;
      --color-bg-dark: #1a1a1a;
      --color-accent: #228B22;
      --color-text: #fdf0d5;
      --vue-color: #fdf0d5;
      --color-border: rgba(255, 255, 255, 0.1);
      --color-shadow: rgba(0, 0, 0, 0.7);

      /* Bars */
      --color-primary: #DB7C26;
      --color-secondary: #C1121F;
      --color-tertiary: #669BBC;

      /* Typography */
      --font-primary: 'Montserrat', sans-serif;
      --font-secondary: 'Roboto', sans-serif;

      /* Sizing */
      --header-height: 80px;
      --sidebar-width: 250px;
      --transition-speed: 0.3s;
    }

    /* Global Reset & Box Sizing */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-secondary);
      background-color: var(--color-bg);
      color: var(--color-text);
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    header {
      position: fixed;
      height: var(--header-height);
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 1000;
      background: var(--color-bg-dark);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
    }

    .header-item {
      margin: 0 10px;
    }

    .header-headline {
      flex: 0.5;
      text-align: left;
    }

    .header-headline h1 {
      font-size: 18px;
      margin: 0;
    }

    .header-yearslider {
      flex: 3;
      text-align: center;
    }

    .header-countryfilter {
      flex: 1;
      text-align: right;
    }

    .header-menu {
      display: flex;
      align-items: center;
    }

    #savedDashboardsSelect+.select2-container {
      margin-left: 20px;
    }

    .burger-icon,
    .account-icon {
      font-size: 24px;
      cursor: pointer;
      color: var(--color-text);
    }

    /* Filter Items */
    .filter-item {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--color-text);
      font-size: 14px;
    }

    /* Sidebar */
    .sidebar {
      height: 100%;
      width: var(--sidebar-width);
      position: fixed;
      top: 0;
      left: calc(-1 * var(--sidebar-width));
      background-color: var(--color-bg-dark);
      overflow-x: hidden;
      transition: left var(--transition-speed) ease;
      z-index: 1200;
      padding-top: 60px;
      color: var(--color-text);
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar .close-sidebar {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: var(--color-text);
    }

    .sidebar .main-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar .main-nav ul li {
      padding: 15px 20px;
      border-bottom: 1px solid var(--color-border);
    }

    .sidebar .main-nav ul li a {
      text-decoration: none;
      color: var(--color-text);
      font-weight: 500;
      display: block;
    }

    .sidebar .main-nav ul li.active a {
      background-color: #444;
      font-weight: bold;
      color: var(--color-text);
    }

    .sidebar .main-nav ul li a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1150;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    .global-blur-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(5px);
      z-index: 1500;
      display: none;
    }

    .global-blur-overlay.active {
      display: block;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: calc(var(--header-height) + 20px) auto 20px auto;
      padding: 20px;
      background: var(--color-bg-dark);
      border-radius: 8px;
      box-shadow: 0 2px 12px var(--color-shadow);
      position: relative;
    }

    /* Main Indicator Wrapper */
    #mainIndicatorWrapper {
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
      color: var(--color-text);
    }

    #mainIndicatorSelect {
      font-size: 16px;
      padding: 4px 8px;
      margin-left: 10px;
      border: 1px solid #3d3d3d;
      border-radius: 4px;
      background-color: var(--color-bg);
      color: var(--color-text);
    }

    /* Chart Layout */
    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-container {
      min-width: 300px;
      height: 500px;
      background: var(--color-bg-medium);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 1px 4px var(--color-shadow);
    }

    /* Expand & Remove Buttons */
    .expand-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: var(--color-text);
      border-radius: 3px;
      padding: 4px 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
      z-index: 10;
    }

    .expand-btn:hover {
      background: rgba(0, 0, 0, 0.7);
    }

    .remove-group-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s ease;
      z-index: 10;
    }

    .remove-group-btn:hover {
      background: #c0392b;
    }

    /* Expanded Containers */
    .chart-container.expanded,
    .additional-chart.expanded {
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      z-index: 9999;
      background: var(--color-bg-dark);
      padding: 20px;
      overflow: auto;
    }

    /* D3 Bar Chart */
    #barChartContainer {
      overflow-y: auto;
      position: relative;
    }

    .chart-container.expanded #barChartContent {
      width: 100%;
      height: 100%;
    }

    .chart-container.expanded #barChartContent svg {
      width: 100% !important;
      height: 100% !important;
    }

    .bar {
      transition: fill 0.2s ease;
    }

    .bar:hover {
      fill: darkorange;
    }

    .bar-text {
      fill: var(--color-text);
      font-size: 12px;
      text-anchor: start;
    }

    .country-label {
      font-size: 12px;
      text-anchor: end;
      fill: var(--color-text);
    }

    /* Map Container */
    #d3Map {
      width: 100%;
      height: 100%;
    }

    /* Additional Groups */
    .additional-group {
      position: relative;
    }

    .additional-threshold-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      max-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .main-threshold-controls {
      position: sticky;
      bottom: 20px;
      margin-left: auto;
      max-width: 160px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .group-indicator-select {
      font-size: 16px;
      padding: 4px 8px;
      border: 1px solid #3d3d3d;
      border-radius: 4px;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 0 auto;
      display: block;
    }

    /* Additional Charts */
    .additional-charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .additional-chart {
      min-width: 300px;
      height: 500px;
      position: relative;
      background: var(--color-bg-medium);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      overflow-y: auto;
      overflow-x: hidden;
      box-shadow: 0 1px 4px var(--color-shadow);
    }

    .additional-chart canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .chart-content {
      position: relative;
      width: 100%;
      height: 100%;
      margin-top: 0;
    }

    /* Additional Charts Control */
    #additionalChartsControl {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #additionalIndicatorSelect {
      font-size: 16px;
      padding: 6px 10px;
      margin: 0;
      border: 1px solid #3d3d3d;
      border-radius: 4px;
      background: var(--color-bg);
      color: var(--color-text);
    }

    #additionalIndicatorSelect+#addChartButton {
      margin-left: 0;
    }

    .dashboard-btn {
      border: none;
      padding: 10px 20px;
      margin: 20px auto;
      display: block;
      border-radius: 5px;
      font-family: var(--font-secondary);
      background-color: var(--color-bg-medium);
      color: var(--color-text);
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
      transition: background 0.3s ease, transform 0.2s ease;
    }

    #addChartButton:hover {
      background: #323232;
    }

    /* Tooltip */
    #tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(50, 50, 50, 0.9);
      color: var(--color-text);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      z-index: 10000;
    }

    /* Modal */
    .modal {
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
    }

    .modal-content {
      position: relative;
      margin: 5% auto;
      padding: 20px;
      width: 90vw;
      min-height: 90vh;
      background: var(--color-bg-dark);
      border-radius: 8px;
      color: var(--color-text);
    }

    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      color: var(--color-text);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .close:hover {
      color: #fff;
    }

    /* Positioniere das User-Info Modal rechts unter dem Account-Icon */
    #userInfoModal {
      position: fixed;
      right: 0px;
      left: auto;
      width: 250px;
      /* Feste Breite */
      z-index: 1500;
      background: transparent;
      border: none;
      box-shadow: none;
    }

    /* Styling des Inhalts */
    .user-info {
      background: var(--color-bg-dark);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
      padding: 15px;
    }

    /* Neue Zeile für den Mode Switch */
    .mode-switch {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
    }

    .mode-switch i {
      font-size: 20px;
      color: var(--color-text);
    }

    /* Toggle Switch Styling */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #2196F3;
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    #openColorPicker {
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-family: var(--font-secondary);
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
      transition: background 0.3s ease, transform 0.2s ease;
      background: var(--color-bg-medium);
      color: var(--color-text);
      /* Optional: adjust margin if needed */
      margin: 20px auto;
    }

    #openColorPicker:hover {
      background: var(--color-bg-medium);
      transform: scale(1.05);
    }

    /* ---------- UI Slider ---------- */
    .ui-slider-handle {
      border-radius: 50%;
      border: 2px solid var(--color-text);
      background: var(--color-bg-medium);
      width: 20px;
      height: 20px;
    }

    .ui-widget.ui-widget-content {
      border: 1px solid #c5c5c5;
      background-color: var(--vue-color)
    }

    .ui-widget-header {
      background-color: var(--color-bg-medium)
    }

    /* ---------- Language selection ---------- */
    .select2-container--open {
      z-index: 1500 !important;
    }

    .select2-container--default .select2-selection--single {
      background-color: var(--vue-color);
      border: 1px solid #aaa;
      border-radius: 4px;
    }

    .select2-container--default .select2-results__option {
      color: #000 !important;
      background-color: var(--vue-color);
    }

    /* ---------- Vue Treeselect Overrides ---------- */
    .vue-treeselect__control,
    .vue-treeselect__single-value,
    .vue-treeselect__placeholder,
    .vue-treeselect__multi-value-item,
    .vue-treeselect__option,
    .vue-treeselect__label,
    .vue-treeselect__value-remove {
      color: black !important;
    }

    .vue-treeselect__control {
      background-color: var(--vue-color);
      height: 36px !important;
      width: 300px !important;
      max-height: 36px !important;
      overflow: hidden !important;
    }

    .vue-treeselect__multi-value-wrapper {
      display: inline-flex !important;
      flex-wrap: nowrap !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      white-space: nowrap !important;
      align-items: center !important;
      max-height: 36px !important;
    }

    .vue-treeselect__multi-value-item {
      white-space: nowrap !important;
      flex: 0 0 auto !important;
      background-color: var(--vue-color);
      border: 1px solid black;
    }

    .vue-treeselect--searchable:not(.vue-treeselect--disabled) .vue-treeselect__value-container {
      cursor: text;
      max-height: 50px;
      overflow-y: auto;
    }

    .vue-treeselect--has-value .vue-treeselect__multi-value {
      margin-bottom: 5px;
      height: 25px;
    }
  </style>
</head>

<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <span class="close-sidebar" id="closeSidebar">&times;</span>
    <nav class="main-nav">
      <ul>
        <!-- Current view "Overview" is marked as active -->
        <li class="active"><a href="{{ url_for('overview') }}">Overview</a></li>
        <!-- Additional entry for country deep dive -->
        <li><a href="{{ url_for('countries') }}">Country Deep Dive</a></li>
        <li><a href="{{ url_for('comparative') }}">Comparative View</a></li>
        <li><a href="{{ url_for('data') }}">Data</a></li>
      </ul>
    </nav>
  </div>
  <!-- Overlay -->
  <div class="overlay" id="overlay"></div>
  <!-- Global Blur Overlay -->
  <div id="globalBlurOverlay" class="global-blur-overlay"></div>
  <header class="header">
    <!-- Burger Menu Icon (Left) -->
    <div class="header-item header-menu" style="text-align: left;">
      <i id="burgerIcon" class="burger-icon fas fa-bars"></i>
      <select id="savedDashboardsSelect" title="Saved Dashboards">
        <option value="" disabled selected>Select Saved Dashboard</option>
        <option value="dashboard1">Dashboard 1</option>
        <option value="dashboard2">Dashboard 2</option>
        <option value="dashboard3">Dashboard 3</option>
      </select>
    </div>
    <!-- Headline -->
    <div class="header-item header-headline" style="flex: 1; text-align: center;">
      <h1>SIQ Company Economy</h1>
    </div>
    <!-- Year Slider -->
    <div class="header-item header-yearslider" style="flex: 3; text-align: center;">
      <label for="yearSlider" class="filter-label" data-i18n="filter.selectYearRange"></label>
      <div id="yearSlider"></div>
      <span id="yearRangeDisplay">2019 - 2019</span>
    </div>
    <!-- Country Filter -->
    <div class="header-item header-countryfilter" id="vueCountrySelectContainer" style="flex: 1; text-align: center;">
      <label class="filter-label" data-i18n="filter.selectCountries"></label>
      <treeselect v-model="selectedCountries" :options="countryOptions" :multiple="true"
        placeholder="Select countries" />
    </div>
    <!-- Language Selector & Account Icon -->
    <div class="header-item header-right" style="display: flex; align-items: center; margin-left: auto;">
      <select id="languageSelector">
        <option value="en" data-flag="gb">English</option>
        <option value="de" data-flag="de">Deutsch</option>
        <option value="es" data-flag="es">Español</option>
        <option value="fr" data-flag="fr">Français</option>
      </select>
      <div class="header-account" style="margin-left: 10px;">
        <i id="accountIcon" class="account-icon fas fa-user"></i>
      </div>
    </div>
  </header>
  <div class="container">
    <!-- Main Indicator Headline with Dropdown -->
    <div id="mainIndicatorWrapper">
      <select id="mainIndicatorSelect">
        <option value="NY.GDP.PCAP.CD">GDP per Capita (current US$)</option>
        <option value="NY.GDP.MKTP.CD">GDP (current US$)</option>
        <option value="SL.UEM.TOTL.ZS">Unemployment (% of total labor force)</option>
        <option value="FP.CPI.TOTL.ZG">Inflation (annual %)</option>
      </select>
    </div>
    <!-- Main Charts: Map & Bar Chart in Grid Layout (50:50) -->
    <div class="chart-row">
      <!-- D3.js World Map Container (Left) -->
      <div class="chart-container" id="mapContainer" data-chart-type="map">
        <button class="expand-btn" title="Expand Chart">⛶</button>
        <svg id="d3Map" width="960" height="500" viewBox="0 0 960 500"></svg>
      </div>
      <!-- D3 Horizontal Bar Chart Container (Right) -->
      <div class="chart-container" id="barChartContainer">
        <button class="expand-btn" title="Expand Chart">⛶</button>
        <div id="barChartContent"></div>
        <!-- Main Threshold Controls positioned at bottom right of this container -->
        <div class="main-threshold-controls">
          <div style="display: flex; align-items: center;">
            <div style="width: 30px; text-align: center;">
              <i class="fas fa-fire" style="color: var(--color-secondary);"></i>
            </div>
            <label style="display: flex; align-items: center; margin-left: 10px;">
              &ge;&nbsp;
              <input type="number" id="redThreshold" value="5" step="0.1" style="width: 60px; margin: 0 5px;" />%
            </label>
          </div>
          <div style="display: flex; align-items: center;">
            <div style="width: 30px; text-align: center;">
              <i class="fas fa-adjust" style="color: var(--color-primary);"></i>
            </div>
            <div style="margin-left: 10px; font-size: 14px;">Medium Threshold</div>
          </div>
          <div style="display: flex; align-items: center;">
            <div style="width: 30px; text-align: center;">
              <i class="fas fa-snowflake" style="color: var(--color-tertiary);"></i>
            </div>
            <label style="display: flex; align-items: center; margin-left: 10px;">
              &le;&nbsp;
              <input type="number" id="blueThreshold" value="0" step="0.1" style="width: 60px; margin: 0 5px;" />%
            </label>
          </div>
        </div>
      </div>
    </div>
    <!-- Additional Charts Section -->
    <div class="additional-charts-section">
      <div id="additionalGroupsContainer"></div>
      <!-- Additional Charts Control (always appears at the bottom) -->
      <div id="additionalChartsControl">
        <button id="createPresentation" class="dashboard-btn" data-i18n="button.createPresentation">
          <i class="fas fa-file-powerpoint"></i> <span class="translation">Create Presentation</span>
        </button>
        <select id="additionalIndicatorSelect"></select><button id="addChartButton" class="dashboard-btn"
          data-i18n="button.addChartGrid">
          <i class="fas fa-plus-square"></i> <span class="translation">Add Chart Grid</span>
        </button>
        <button id="saveStateBtn" class="dashboard-btn" data-i18n="button.saveState">
          <i class="fas fa-save"></i> <span class="translation">Save State</span>
        </button>
      </div>
    </div>
  </div>
  <!-- Tooltip for the world map -->
  <div id="tooltip"></div>
  <!-- Modal for Expanded Horizontal Bar Chart -->
  <div id="chartModal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="close">&times;</span>
      <div id="modalChartContainer"></div>
    </div>
  </div>
  <!-- Benutzer-Info Modal -->
  <div id="userInfoModal" class="modal" style="display:none;">
    <div class="modal-content user-info" style="max-width:250px; padding:15px;">
      <span id="closeUserInfoModal" style="cursor:pointer; float:right;">&times;</span>
      <h2 data-i18n="account.title">Benutzerkonto</h2>
      <p data-i18n="account.usernamePlaceholder">Name: [Benutzername]</p>
      <p data-i18n="account.orgPlaceholder">Organisation: [Organisation]</p>

      <!-- Dark/Light Mode Switch -->
      <div class="mode-switch"
        style="display: flex; align-items: center; justify-content: space-between; padding: 10px 0;">
        <i class="fas fa-moon"></i>
        <label class="switch">
          <input type="checkbox" id="modeToggle">
          <span class="slider"></span>
        </label>
        <i class="fas fa-sun"></i>
      </div>

      <button id="openColorPicker" data-i18n="account.openColorPicker">Farben anpassen</button>
    </div>
  </div>

  <!-- Modal für Farb-Einstellungen -->
  <div id="colorModal" class="modal" style="display:none;">
    <div class="modal-content"
      style="position:relative; padding:20px; max-width:500px; margin:100px auto; background:#333; border-radius:8px; color:#e0e0e0;">
      <span id="closeColorModal"
        style="position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer;">&times;</span>
      <h2>Customize Colors</h2>

      <!-- Quadrant Colors Section -->
      <h3>Quadrant Colors</h3>
      <div id="quadrantColorSettings">
        <div class="color-row">
          <label for="q1Color">Bar 1 (Above treshold):</label>
          <input type="color" id="q1Color" value="#C1121F">
        </div>
        <div class="color-row">
          <label for="q2Color">Bar 2 (Between tresholds):</label>
          <input type="color" id="q2Color" value="#DB7C26">
        </div>
        <div class="color-row">
          <label for="q3Color">Bar 3 (Below treshold):</label>
          <input type="color" id="q3Color" value="#669BBC">
        </div>
      </div>

      <hr style="margin:20px 0; border-color: #555;">

      <!-- Dashboard Theme Colors Section -->
      <h3>Dashboard Theme</h3>
      <div id="themeSettings">
        <div class="color-row">
          <label for="color-bg">Background:</label>
          <input type="color" id="color-bg" value="#1a1a1a">
        </div>
        <div class="color-row">
          <label for="color-bg-light">Header:</label>
          <input type="color" id="color-bg-light" value="#1a1a1a">
        </div>
        <div class="color-row">
          <label for="color-bg-medium">Charts Background:</label>
          <input type="color" id="color-bg-medium" value="#333333">
        </div>
        <div class="color-row">
          <label for="color-bg-dark">Charts Grid Background:</label>
          <input type="color" id="color-bg-dark" value="#1a1a1a">
        </div>
        <div class="color-row">
          <label for="color-text">Text Color:</label>
          <input type="color" id="color-text" value="#fdf0d5">
        </div>
      </div>

      <!-- Save Colors Button -->
      <div style="text-align:center; margin-top:20px;">
        <button id="saveColorsButton" style="margin-top: 50px; padding:10px 20px; font-size:16px; cursor:pointer;">Save
          colors</button>
      </div>
    </div>
  </div>
  <!-- Vue Instance for Treeselect and State Management -->
  <script>
    // Hilfsfunktion: Ersetzt bei der Auswahl alle Gruppen durch deren Kinder (Blattknoten)
    function extractLeafNodes(selected, options) {
      const groupMap = {};
      options.forEach(group => {
        if (group.children && group.children.length > 0) {
          // Speichere alle Kinder (IDs) der Gruppe
          groupMap[group.id] = group.children.map(child => child.id);
        }
      });
      let result = [];
      selected.forEach(item => {
        if (groupMap[item]) {
          // Falls eine Gruppe ausgewählt wurde, füge alle zugehörigen Länder hinzu
          result.push(...groupMap[item]);
        } else {
          result.push(item);
        }
      });
      // Entferne doppelte Einträge
      return [...new Set(result)];
    }

    Vue.component('treeselect', VueTreeselect.Treeselect);
    // Speichere die Vue-Instanz global für die Wiederherstellung des Zustands
    window.vueCountrySelectVm = new Vue({
      el: '#vueCountrySelectContainer',
      data: {
        selectedCountries: [], // Raw: Gruppen und einzelne Länder
        countryOptions: []
      },
      watch: {
        selectedCountries(newVal) {
          console.log("Raw selected countries:", JSON.stringify(newVal, null, 2));
          // Speichere den raw Wert für die spätere State-Wiederherstellung
          window.selectedCountriesRaw = newVal;
          // Erzeuge aus der raw Auswahl das Array mit den Blattknoten für das Dashboard
          const leafSelection = extractLeafNodes(newVal, this.countryOptions);
          console.log("Leaf selection for Dashboard:", JSON.stringify(leafSelection, null, 2));
          window.selectedCountries = leafSelection;
          updateDashboard();
        }
      },
      created() {
        if (window.countriesInfo) {
          this.buildOptions();
        } else {
          const interval = setInterval(() => {
            if (window.countriesInfo) {
              clearInterval(interval);
              this.buildOptions();
            }
          }, 100);
        }
      },
      methods: {
        buildOptions() {
          const regionsMap = {};
          window.countriesInfo.forEach(country => {
            let regionName = country.region.value.trim();
            if (!regionName) regionName = "Other";
            if (!regionsMap[regionName]) {
              regionsMap[regionName] = [];
            }
            // Füge das einzelne Land als Blattknoten hinzu
            regionsMap[regionName].push({ id: country.name, label: country.name });
          });
          // Erstelle hierarchische Optionen: Jede Gruppe hat als id den Gruppennamen und als children die einzelnen Länder
          this.countryOptions = Object.keys(regionsMap).map(region => ({
            id: region,
            label: region,
            children: regionsMap[region]
          }));
          window.countryOptions = this.countryOptions;
          // Wenn bereits ein gespeicherter State existiert, beibehalten, sonst initialisieren
          if (window.selectedCountriesRaw && window.selectedCountriesRaw.length > 0) {
            this.selectedCountries = window.selectedCountriesRaw;
          } else {
            this.selectedCountries = [];
            window.selectedCountriesRaw = [];
            window.selectedCountries = [];
          }
          updateDashboard();
        }
      }
    });
  </script>
  <!-- Sidebar, Map, and Additional Groups Scripts -->
  <script>
    const burgerIcon = document.getElementById('burgerIcon');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const closeSidebar = document.getElementById('closeSidebar');
    burgerIcon.addEventListener('click', () => { sidebar.classList.add('active'); overlay.classList.add('active'); });
    closeSidebar.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); });
    overlay.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); });
    const accountIcon = document.getElementById('accountIcon');
  </script>
  <!-- Updated Chart Scripts -->
  <script>
    let countriesInfo = null;
    const countriesMapping = {}; // For flag images (ISO2 codes)
    const iso3Mapping = {}; // For deep dive URLs (ISO3 codes)
    window.countriesInfo = null;
    window.selectedCountries = [];
    window.filteredCountries = new Set();
    const indicators = [
      { id: "NY.GDP.PCAP.CD", name: "GDP per Capita (current US$)" },
      { id: "NY.GDP.MKTP.CD", name: "GDP (current US$)" },
      { id: "SL.UEM.TOTL.ZS", name: "Unemployment (% of total labor force)" },
      { id: "FP.CPI.TOTL.ZG", name: "Inflation (annual %)" }
    ];
    let mainIndicator = indicators[0].id;
    let mainIndicatorName = indicators[0].name;
    // Dynamic color scale function
    function getUserDefinedColorScale(minValue, maxValue) {
      return d3.scaleLinear()
        .domain([minValue, maxValue])
        .range(["lightblue", "darkblue"]);
    }
    const getValueFormatter = indicator => {
      if (indicator === "NY.GDP.PCAP.CD" || indicator === "NY.GDP.MKTP.CD")
        return d3.format("$.2s");
      else if (indicator === "SL.UEM.TOTL.ZS" || indicator === "FP.CPI.TOTL.ZG")
        return d => d3.format(",.1f")(d) + "%";
      else return d3.format(",.0f");
    };
    // Main threshold function using main controls
    function thresholdColor(deviation) {
      const blueThreshold = +document.getElementById("blueThreshold").value;
      const redThreshold = +document.getElementById("redThreshold").value;
      if (deviation < blueThreshold) return "var(--color-tertiary)";
      else if (deviation > redThreshold) return "var(--color-secondary)";
      else return "var(--color-primary)";
    }
    // Local additional threshold function for each additional group (reads from local controls)
    function localAdditionalThresholdColor(container, deviation) {
      if (!container || typeof container.closest !== 'function') {
        return thresholdColor(deviation);
      }
      const group = container.closest('.additional-group');
      if (!group) { return thresholdColor(deviation); }
      const blueInput = group.querySelector('.additionalBlueThreshold');
      const redInput = group.querySelector('.additionalRedThreshold');
      const blueThreshold = blueInput ? +blueInput.value : 0;
      const redThreshold = redInput ? +redInput.value : 5;
      if (deviation < blueThreshold) return "var(--color-tertiary)";
      else if (deviation > redThreshold) return "var(--color-secondary)";
      else return "var(--color-primary)";
    }
    function populateIndicatorSelect(selectElement) {
      selectElement.innerHTML = "";
      indicators.forEach(ind => {
        const option = document.createElement("option");
        option.value = ind.id;
        option.textContent = ind.name;
        selectElement.appendChild(option);
      });
    }
    const mainIndicatorSelect = document.getElementById("mainIndicatorSelect");
    populateIndicatorSelect(mainIndicatorSelect);
    mainIndicatorSelect.value = mainIndicator;
    const additionalIndicatorSelect = document.getElementById("additionalIndicatorSelect");
    populateIndicatorSelect(additionalIndicatorSelect);
    mainIndicatorSelect.addEventListener("change", function () {
      mainIndicator = this.value;
      mainIndicatorName = this.options[this.selectedIndex].textContent;
      updateDashboard();
    });
    const yearSlider = document.getElementById('yearSlider');
    $("#yearSlider").slider({
      range: true,
      min: 1990,
      max: 2023,
      values: [2019, 2019],
      slide: function (event, ui) {
        $("#yearRangeDisplay").text(ui.values[0] + " - " + ui.values[1]);
      },
      change: function (event, ui) {
        updateDashboard();
      }
    });
    const yearRangeDisplay = document.getElementById('yearRangeDisplay');
    document.getElementById("blueThreshold").addEventListener("input", updateDashboard);
    document.getElementById("redThreshold").addEventListener("input", updateDashboard);
    window.addEventListener("resize", updateDashboard);
    async function fetchGDPData(yearRange, indicator) {
      const ind = indicator || "NY.GDP.PCAP.CD";
      let countryData = countriesInfo;
      if (!countryData) {
        const response = await fetch("{{ url_for('static', filename='countries.json') }}");
        countryData = await response.json();
      }
      const countryCodes = countryData.map(country => country.id).join(";");
      if (!countryCodes) { throw new Error("No valid country codes found."); }
      const url = `https://api.worldbank.org/v2/country/${countryCodes}/indicator/${ind}?date=${yearRange}&format=json&per_page=7310`;
      const result = await fetch(url);
      const data = await result.json();
      if (!data || data.length < 2 || !Array.isArray(data[1])) { throw new Error("Invalid data received from World Bank API."); }
      return data[1];
    }
    function processGDPData(data, startYear, endYear) {
      const countryData = {};
      data.forEach(item => {
        if (item.value !== null) {
          const countryName = item.country.value;
          const value = item.value;
          const year = item.date;
          if (!countryData[countryName]) {
            countryData[countryName] = { total: 0, count: 0, values: {} };
          }
          countryData[countryName].total += value;
          countryData[countryName].count += 1;
          countryData[countryName].values[year] = value;
        }
      });
      const processed = [];
      for (const country in countryData) {
        const values = countryData[country].values;
        const avg = countryData[country].total / countryData[country].count;
        const obj = { country, avgGDP: avg };
        const endVal = values[endYear];
        if (endVal == null) continue;
        obj.endValue = endVal;
        if (startYear !== endYear) {
          const startVal = values[startYear];
          if (startVal != null && startVal !== 0) {
            obj.deviation = Math.round(((endVal - startVal) / startVal) * 100);
          } else { continue; }
        }
        processed.push(obj);
      }
      return processed;
    }
    function processMapData(data, startYear, endYear) {
      const countryData = {};
      data.forEach(item => {
        if (item.value !== null) {
          const iso3 = item.countryiso3code;
          const value = item.value;
          const year = item.date;
          if (!countryData[iso3]) { countryData[iso3] = { total: 0, count: 0, values: {} }; }
          countryData[iso3].total += value;
          countryData[iso3].count += 1;
          countryData[iso3].values[year] = value;
        }
      });
      const result = {};
      for (const iso3 in countryData) {
        const avg = countryData[iso3].total / countryData[iso3].count;
        if (startYear === endYear) { result[iso3] = avg; }
        else {
          const startVal = countryData[iso3].values[startYear];
          const endVal = countryData[iso3].values[endYear];
          if (startVal != null && endVal != null && startVal !== 0) {
            result[iso3] = Math.round(((endVal - startVal) / startVal) * 100);
          }
        }
      }
      return result;
    }
    // Global cache object to store Base64 flag images
    let flagCache = {};

    // Helper function: Given an ISO code, it fetches the flag image and returns a Base64 data URL.
    async function loadFlagBase64(iso) {
      if (flagCache[iso]) {
        return flagCache[iso];
      }
      const imageUrl = `https://flagcdn.com/w40/${iso.toLowerCase()}.png`;
      try {
        const response = await fetch(imageUrl, { mode: "cors", cache: "no-cache" });
        if (!response.ok) {
          console.error(`Failed to fetch flag for ISO ${iso}: ${response.status}`);
          return imageUrl; // Fallback: return the image URL if conversion fails
        }
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            flagCache[iso] = reader.result;  // Cache the converted Base64 string
            resolve(reader.result);
          };
          reader.onerror = error => {
            console.error(`Error converting flag image for ISO ${iso}:`, error);
            reject(error);
          };
          reader.readAsDataURL(blob);
        });
      } catch (error) {
        console.error("Error fetching image:", error);
        return imageUrl;
      }
    }

    function renderBarChartD3(data, yearRange, indicator, containerElement, indicatorFriendlyName) {
      const container = containerElement || document.getElementById("barChartContent");
      container.innerHTML = "";
      const barHeight = 20;
      const margin = { top: 70, right: 100, bottom: 20, left: 180 };
      const years = yearRange.split(":");
      const isSingleYear = (years[0] === years[1]);
      const additionalGroupContext =
        (containerElement && containerElement.closest && containerElement.closest('.additional-group')) ||
        containerElement._additionalGroup;
      const isAdditional = !!additionalGroupContext;
      data.forEach(d => { d.gdp = d.avgGDP; });
      data.sort((a, b) => b.gdp - a.gdp);
      const containerWidth = container.clientWidth;
      const height = data.length * barHeight + margin.top + margin.bottom;
      const svg = d3.select(container)
        .append("svg")
        .attr("id", "chart")
        .attr("width", containerWidth)
        .attr("height", height);

      let chartIndicatorName = indicatorFriendlyName || mainIndicatorName;
      if (isAdditional) {
        const group = container.closest('.additional-group');
        chartIndicatorName = (group && group._indicatorName) ? group._indicatorName : (indicatorFriendlyName || indicator);
      }

      svg.append("text")
        .attr("class", "chart-headline")
        .attr("x", containerWidth / 2)
        .attr("y", 40)
        .attr("text-anchor", "middle")
        .style("fill", "var(--color-text)")
        .style("font-size", "20px")
        .style("font-weight", "bold")
        .text(years[1] + " | " + chartIndicatorName);

      const x = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.gdp)])
        .range([0, containerWidth - margin.left - margin.right]);
      const y = d3.scaleBand()
        .domain(data.map((d, i) => i))
        .range([margin.top, height - margin.bottom])
        .padding(0.1);

      const valueFormatter = getValueFormatter(indicator);
      const bars = svg.selectAll(".bar-group")
        .data(data)
        .enter()
        .append("g")
        .attr("class", "bar-group")
        .attr("transform", (d, i) => `translate(${margin.left}, ${y(i)})`)
        .style("cursor", "pointer")
        .on("click", (event, d) => {
          const iso = iso3Mapping[d.country.toLowerCase()] || d.country;
          window.location.href = "countries?country=" + encodeURIComponent(iso);
        });

      // Append country label
      bars.append("text")
        .attr("class", "country-label")
        .attr("x", -70)
        .attr("y", y.bandwidth() / 2)
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .style("fill", "var(--color-text)")
        .text(d => d.country);

      // Append placeholder flag image using an external URL as a fallback
      bars.append("image")
        .attr("crossorigin", "anonymous")
        .attr("xlink:href", d => {
          const iso = countriesMapping[d.country.toLowerCase()];
          return iso ? `https://flagcdn.com/w40/${iso.toLowerCase()}.png` : "";
        })
        .attr("x", -50)
        .attr("y", (y.bandwidth() - 16) / 2)
        .attr("width", 30)
        .attr("height", 16);

      // After bars are rendered, update each flag image with the Base64 version
      bars.each(function (d) {
        const iso = countriesMapping[d.country.toLowerCase()];
        if (iso) {
          loadFlagBase64(iso)
            .then(base64Image => {
              d3.select(this).select("image").attr("xlink:href", base64Image);
            })
            .catch(error => {
              console.error(`Error loading Base64 for ${d.country}:`, error);
            });
        }
      });

      // Append bar rectangles
      bars.append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("width", d => Math.max(x(d.gdp), 0))
        .attr("height", y.bandwidth())
        .attr("fill", function (d) {
          if (isSingleYear) {
            const values = data.map(d => d.endValue);
            const minValue = d3.min(values);
            const maxValue = d3.max(values);
            const colorScale = getUserDefinedColorScale(minValue, maxValue);
            return colorScale(d.endValue);
          } else {
            if (isAdditional) {
              return localAdditionalThresholdColor(additionalGroupContext, d.deviation);
            } else {
              return thresholdColor(d.deviation);
            }
          }
        });

      // If not a single year, add percentage labels, threshold icons, and bar text.
      if (!isSingleYear) {
        bars.append("text")
          .attr("class", "percentage-label")
          .attr("x", 5)
          .attr("y", y.bandwidth() / 2)
          .attr("dy", ".35em")
          .style("fill", "var(--color-text)")
          .style("font-size", "12px")
          .text(d => (d.deviation >= 0 ? '+' : '') + d.deviation + '%');
        bars.filter((d, i) => i === 0)
          .select("text.percentage-label")
          .text(d => (d.deviation >= 0 ? '+' : '') + d.deviation + '% (since ' + years[0] + ')');
        bars.append("text")
          .attr("class", "threshold-icon")
          .attr("x", d => Math.max(x(d.gdp) - 20, 0))
          .attr("y", y.bandwidth() / 2)
          .attr("dy", ".35em")
          .style("font-family", '"Font Awesome 5 Free"')
          .style("font-weight", "900")
          .style("fill", "var(--color-text)")
          .style("font-size", "14px")
          .text(d => {
            const color = isAdditional ? localAdditionalThresholdColor(container, d.deviation) : thresholdColor(d.deviation);
            if (color === "var(--color-secondary)") return "\uf06d";
            else if (color === "var(--color-primary)") return "\uf042";
            else if (color === "var(--color-tertiary)") return "\uf2dc";
            else return "";
          });
        bars.append("text")
          .attr("class", "bar-text")
          .attr("x", d => Math.max(x(d.gdp), 0))
          .attr("y", y.bandwidth() / 2)
          .attr("dy", ".35em")
          .style("fill", "var(--color-text)")
          .text(d => valueFormatter(d.endValue));
        // Adjust label positions for narrow bars
        bars.each(function (d) {
          const barWidth = x(d.gdp);
          const group = d3.select(this);
          if (barWidth < 50) {
            group.select("text.threshold-icon").style("display", "none");
            group.select("text.percentage-label").attr("x", barWidth + 5);
            group.select("text.bar-text").attr("x", barWidth + 5 + 50);
          } else {
            group.select("text.threshold-icon")
              .style("display", null)
              .attr("x", Math.max(barWidth - 20, 0));
            group.select("text.percentage-label").attr("x", 5);
            group.select("text.bar-text").attr("x", Math.max(barWidth, 0));
          }
        });
      } else {
        // For single-year display: only include the bar text.
        bars.append("text")
          .attr("class", "bar-text")
          .attr("x", d => Math.max(x(d.gdp), 0))
          .attr("y", y.bandwidth() / 2)
          .attr("dy", ".35em")
          .style("fill", "var(--color-text)")
          .text(d => valueFormatter(d.endValue));
      }

      // Handle window resize events to update bar chart dimensions
      window.addEventListener("resize", () => {
        const newWidth = container.clientWidth;
        svg.attr("width", newWidth);
        x.range([0, newWidth - margin.left - margin.right]);
        svg.selectAll("rect.bar").attr("width", d => Math.max(x(d.gdp), 0));
        svg.selectAll("text.bar-text").attr("x", d => Math.max(x(d.gdp), 0));
        if (!isSingleYear) {
          svg.selectAll("text.percentage-label").attr("x", 5);
          svg.selectAll("text.threshold-icon").attr("x", d => Math.max(x(d.gdp) - 20, 0));
        }
      });
    }


    window.updateAdditionalGroup = async function (group) {
      if (!group._indicator) {
        group._worldMapContent.innerHTML = "";
        group._barChartContent.innerHTML = "";
        return;
      }
      try {
        const values = $("#yearSlider").slider("values");
        const yearRangeParam = values.join(":");
        const [startYear, endYear] = yearRangeParam.split(":");
        const additionalControls = group.querySelector('.additional-threshold-controls');
        additionalControls.style.display = startYear === endYear ? 'none' : 'flex';
        const indicator = group._indicator;
        const indicatorName = group._indicatorName;
        const redThresholdInput = group.querySelector('.additionalRedThreshold');
        const blueThresholdInput = group.querySelector('.additionalBlueThreshold');
        const redThreshold = redThresholdInput ? +redThresholdInput.value : 5;
        const blueThreshold = blueThresholdInput ? +blueThresholdInput.value : 0;
        function groupAdditionalThresholdColor(deviation) {
          if (deviation < blueThreshold) return "var(--color-tertiary)";
          else if (deviation > redThreshold) return "var(--color-secondary)";
          else return "var(--color-primary)";
        }
        const rawData = await fetchGDPData(yearRangeParam, indicator);
        let processed = processGDPData(rawData, ...yearRangeParam.split(":"));
        processed.forEach(d => { d.gdp = d.avgGDP; });
        if (window.filteredCountries.size > 0) {
          processed = processed.filter(d => window.filteredCountries.has(d.country));
        }
        renderGroupWorldMap(group._worldMapContent, rawData, yearRangeParam, indicator, indicatorName, groupAdditionalThresholdColor, redThreshold, blueThreshold);
        renderBarChartD3(processed, yearRangeParam, indicator, group._barChartContent, indicatorName);
      } catch (error) {
        console.error("Update additional group failed:", error);
      }
    };
    function renderGroupWorldMap(container, rawData, year, indicator, indicatorName, thresholdFn, redThreshold, blueThreshold) {
      let svgWidth = container.clientWidth;
      let svgHeight = container.clientHeight;
      if (container.classList.contains("expanded")) {
        svgWidth = window.innerWidth;
        svgHeight = window.innerHeight;
      }
      const svg = d3.select(container)
        .html("")
        .append("svg")
        .attr("width", svgWidth)
        .attr("height", svgHeight);
      svg.append("text")
        .attr("class", "chart-headline")
        .attr("x", svgWidth / 2)
        .attr("y", 40)
        .attr("text-anchor", "middle")
        .style("fill", "var(--color-text)")
        .style("font-size", "20px")
        .style("font-weight", "bold")
        .text(indicatorName);
      if (worldGeoJSON) {
        const [startYear, endYear] = year.split(":");
        const isSingleYear = (startYear === endYear);
        // Hier den legend-Formatter definieren: bei mehreren Jahren als Prozentanzeige
        const legendFormatter = isSingleYear ? getValueFormatter(indicator) : d => `${d}%`;
        const mapData = processMapData(rawData, startYear, endYear);
        const projection = d3.geoMercator().fitSize([svgWidth, svgHeight], worldGeoJSON);
        const path = d3.geoPath().projection(projection);
        const g = svg.append("g");
        const valueFormatter = getValueFormatter(indicator);
        const filteredCountries = window.filteredCountries || new Set();
        g.selectAll("path")
          .data(worldGeoJSON.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill", d => {
            if (filteredCountries.size > 0 && !filteredCountries.has(d.properties.name))
              return "transparent";
            const isoCode = d.properties.iso_a3 || d.id;
            const value = mapData[isoCode] || 0;
            return isSingleYear
              ? (value > 0 ? getUserDefinedColorScale(d3.min(Object.values(mapData)), d3.max(Object.values(mapData)))(value) : "#444")
              : thresholdFn(value);
          })
          .attr("stroke", "#666")
          .attr("stroke-width", 0.5)
          .on("click", (event, d) => {
            const isoCode = d.properties.iso_a3 || d.id;
            window.location.href = "countries?country=" + isoCode;
          })
          .on("mouseover", function (event, d) {
            d3.select(this).attr("stroke-width", 2);
            d3.select("#tooltip")
              .style("display", "block")
              .html(`<strong>${d.properties.name}</strong><br>${indicatorName}: ${valueFormatter(mapData[d.properties.iso_a3 || d.id] || 0)}<br>Click to redirect`);
          })
          .on("mousemove", function (event) {
            d3.select("#tooltip")
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY + 10) + "px");
          })
          .on("mouseout", function () {
            d3.select(this).attr("stroke-width", 0.5);
            d3.select("#tooltip").style("display", "none");
          });
        const legendWidth = 200, legendHeight = 10;
        const legendX = svgWidth - legendWidth - 20, legendY = svgHeight - 40;
        const defs = svg.append("defs");
        const gradient = defs.append("linearGradient")
          .attr("id", "legend-gradient-additional")
          .attr("x1", "0%")
          .attr("y1", "0%")
          .attr("x2", "100%")
          .attr("y2", "0%");
        if (isSingleYear) {
          gradient.append("stop").attr("offset", "0%").attr("stop-color", "lightblue");
          gradient.append("stop").attr("offset", "100%").attr("stop-color", "darkblue");
        } else {
          gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "var(--color-secondary)");
          gradient.append("stop")
            .attr("offset", "50%")
            .attr("stop-color", "var(--color-primary)");
          gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "var(--color-tertiary)");
        }
        svg.append("rect")
          .attr("x", legendX)
          .attr("y", legendY)
          .attr("width", legendWidth)
          .attr("height", legendHeight)
          .style("fill", "url(#legend-gradient-additional)")
          .style("stroke", "#666")
          .style("stroke-width", 0.5);
        svg.append("text")
          .attr("x", legendX)
          .attr("y", legendY - 5)
          .attr("text-anchor", "start")
          .style("font-size", "12px")
          .style("fill", "var(--color-text)")
          .text(legendFormatter(blueThreshold));
        svg.append("text")
          .attr("x", legendX + legendWidth)
          .attr("y", legendY - 5)
          .attr("text-anchor", "end")
          .style("font-size", "12px")
          .style("fill", "var(--color-text)")
          .text(legendFormatter(redThreshold));
        const zoom = d3.zoom()
          .scaleExtent([1, 8])
          .on("zoom", event => { g.attr("transform", event.transform); });
        const initialTransform = d3.zoomIdentity.translate(-250, 0).scale(1.5);
        svg.call(zoom).call(zoom.transform, initialTransform);
      }
    }
    function openChartModal() {
      const modal = document.getElementById("chartModal");
      modal.style.display = "block";
      const modalContainer = document.getElementById("modalChartContainer");
      modalContainer.innerHTML = "";
      const values = $("#yearSlider").slider("values");
      const yearRangeParam = values.join(":");
      fetchGDPData(yearRangeParam, mainIndicator)
        .then(rawData => {
          let processed = processGDPData(rawData, ...yearRangeParam.split(":"));
          if (window.filteredCountries.size > 0) {
            processed = processed.filter(d => window.filteredCountries.has(d.country));
          }
          renderBarChartD3(processed, yearRangeParam, mainIndicator, modalContainer, mainIndicatorName);
        })
        .catch(error => { console.error("Modal chart update failed:", error); });
    }
    function openAdditionalBarChartModal(group) {
      const modal = document.getElementById("chartModal");
      modal.style.display = "block";
      const modalContainer = document.getElementById("modalChartContainer");
      modalContainer.innerHTML = "";
      modalContainer._additionalGroup = group;
      const values = $("#yearSlider").slider("values");
      const yearRangeParam = values.join(":");
      const indicator = group._indicator;
      fetchGDPData(yearRangeParam, indicator)
        .then(rawData => {
          let processed = processGDPData(rawData, ...yearRangeParam.split(":"));
          if (window.filteredCountries.size > 0) {
            processed = processed.filter(d => window.filteredCountries.has(d.country));
          }
          renderBarChartD3(processed, yearRangeParam, indicator, modalContainer, group._indicatorName);
        })
        .catch(error => { console.error("Additional bar chart modal update failed:", error); });
    }
    document.getElementById("modalClose").addEventListener("click", function () {
      document.getElementById("chartModal").style.display = "none";
    });
    document.addEventListener("click", function (e) {
      if (e.target && e.target.classList.contains("expand-btn")) {
        const container = e.target.parentElement;
        if (container.id === "barChartContainer") { openChartModal(); }
        else if (container.dataset.chartType === "bar" && container.closest('.additional-group')) {
          const group = container.closest('.additional-group');
          openAdditionalBarChartModal(group);
        } else {
          container.classList.toggle("expanded");
          e.target.innerHTML = container.classList.contains("expanded") ? "✕" : "⛶";
          const blurOverlay = document.getElementById("globalBlurOverlay");
          if (container.classList.contains("expanded")) { blurOverlay.classList.add("active"); }
          else { blurOverlay.classList.remove("active"); }
          if (container.dataset.chartType === "map") {
            const group = e.target.closest('.additional-group');
            if (group) { updateAdditionalGroup(group); }
          }
        }
      }
    });
    document.getElementById("addChartButton").addEventListener("click", function () {
      const selectedIndicator = additionalIndicatorSelect.value;
      const newGroup = createAdditionalGroup(selectedIndicator, additionalIndicatorSelect.options[additionalIndicatorSelect.selectedIndex].textContent);
      document.getElementById("additionalGroupsContainer").appendChild(newGroup);
      updateAdditionalGroup(newGroup);
    });
    function createAdditionalGroup(indicator, indicatorName) {
      const groupContainer = document.createElement('div');
      groupContainer.className = 'additional-group';
      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-group-btn";
      removeBtn.title = "Remove this chart group";
      removeBtn.textContent = "x";
      removeBtn.addEventListener("click", function () { groupContainer.remove(); });
      groupContainer.appendChild(removeBtn);
      const dropdownWrapper = document.createElement('div');
      dropdownWrapper.className = 'dropdown-wrapper';
      dropdownWrapper.style.textAlign = 'center';
      dropdownWrapper.style.padding = '10px 0';
      dropdownWrapper.style.background = '#2c2c2c';
      dropdownWrapper.style.borderBottom = '1px solid #3d3d3d';
      const groupIndicatorSelect = document.createElement('select');
      groupIndicatorSelect.className = 'group-indicator-select';
      indicators.forEach(ind => {
        const option = document.createElement("option");
        option.value = ind.id;
        option.textContent = ind.name;
        groupIndicatorSelect.appendChild(option);
      });
      groupIndicatorSelect.value = indicator;
      groupIndicatorSelect.addEventListener('change', function () {
        groupContainer._indicator = this.value;
        groupContainer._indicatorName = this.options[this.selectedIndex].textContent;
        updateAdditionalGroup(groupContainer);
      });
      dropdownWrapper.appendChild(groupIndicatorSelect);
      groupContainer.appendChild(dropdownWrapper);
      const chartsContainer = document.createElement('div');
      chartsContainer.className = 'additional-charts-container';
      const worldMapChartDiv = document.createElement('div');
      worldMapChartDiv.className = 'additional-chart';
      worldMapChartDiv.dataset.chartType = "map";
      const expandBtn1 = document.createElement("button");
      expandBtn1.className = "expand-btn";
      expandBtn1.title = "Expand Chart";
      expandBtn1.innerHTML = "⛶";
      worldMapChartDiv.appendChild(expandBtn1);
      const worldMapContentDiv = document.createElement('div');
      worldMapContentDiv.className = 'chart-content';
      worldMapChartDiv.appendChild(worldMapContentDiv);
      const barChartDiv = document.createElement('div');
      barChartDiv.className = 'additional-chart';
      barChartDiv.dataset.chartType = "bar";
      const expandBtn2 = document.createElement("button");
      expandBtn2.className = "expand-btn";
      expandBtn2.title = "Expand Chart";
      expandBtn2.innerHTML = "⛶";
      barChartDiv.appendChild(expandBtn2);
      const barChartContentDiv = document.createElement('div');
      barChartContentDiv.className = 'chart-content';
      barChartDiv.appendChild(barChartContentDiv);
      chartsContainer.appendChild(worldMapChartDiv);
      chartsContainer.appendChild(barChartDiv);
      groupContainer.appendChild(chartsContainer);
      const thresholdControls = document.createElement('div');
      thresholdControls.className = 'additional-threshold-controls';
      const fireRow = document.createElement('div');
      fireRow.style.display = 'flex';
      fireRow.style.alignItems = 'center';
      fireRow.innerHTML = `
        <div style="width: 30px; text-align: center;">
          <i class="fas fa-fire" style="color: var(--color-secondary);"></i>
        </div>
        <label style="display: flex; align-items: center; margin-left: 10px;">
          &ge;&nbsp;
          <input type="number" class="additionalRedThreshold" value="5" step="0.1" style="width: 60px; margin: 0 5px;" />%
        </label>
      `;
      thresholdControls.appendChild(fireRow);
      const mediumRow = document.createElement('div');
      mediumRow.style.display = 'flex';
      mediumRow.style.alignItems = 'center';
      mediumRow.innerHTML = `
        <div style="width: 30px; text-align: center;">
          <i class="fas fa-adjust" style="color: var(--color-primary);"></i>
        </div>
        <div style="margin-left: 10px; font-size: 14px;">Medium Threshold</div>
      `;
      thresholdControls.appendChild(mediumRow);
      const snowflakeRow = document.createElement('div');
      snowflakeRow.style.display = 'flex';
      snowflakeRow.style.alignItems = 'center';
      snowflakeRow.innerHTML = `
        <div style="width: 30px; text-align: center;">
          <i class="fas fa-snowflake" style="color: var(--color-tertiary);"></i>
        </div>
        <label style="display: flex; align-items: center; margin-left: 10px;">
          &le;&nbsp;
          <input type="number" class="additionalBlueThreshold" value="0" step="0.1" style="width: 60px; margin: 0 5px;" />%
        </label>
      `;
      thresholdControls.appendChild(snowflakeRow);
      groupContainer.appendChild(thresholdControls);
      groupContainer._indicator = indicator;
      groupContainer._indicatorName = indicatorName;
      groupContainer._worldMapContent = worldMapContentDiv;
      groupContainer._barChartContent = barChartContentDiv;
      const additionalRedThresholdInput = thresholdControls.querySelector('.additionalRedThreshold');
      const additionalBlueThresholdInput = thresholdControls.querySelector('.additionalBlueThreshold');
      additionalRedThresholdInput.addEventListener('input', function () {
        updateAdditionalGroup(groupContainer);
      });
      additionalBlueThresholdInput.addEventListener('input', function () {
        updateAdditionalGroup(groupContainer);
      });
      return groupContainer;
    }
    let worldGeoJSON = null;
    Promise.all([
      fetch("{{ url_for('static', filename='countries.json') }}").then(response => response.json()),
      d3.json("{{ url_for('static', filename='world.geojson') }}")
    ]).then(([countriesData, worldData]) => {
      countriesInfo = countriesData;
      window.countriesInfo = countriesData;
      countriesData.forEach(d => {
        countriesMapping[d.name.toLowerCase()] = d.iso2Code;
        iso3Mapping[d.name.toLowerCase()] = d.id;
      });
      worldGeoJSON = worldData;
      updateDashboard();
    }).catch(error => { console.error("Error loading data:", error); });
    function updateThresholdControlsVisibility(startYear, endYear) {
      const mainControls = document.querySelector('.main-threshold-controls');
      if (startYear === endYear) { mainControls.style.display = 'none'; }
      else { mainControls.style.display = 'flex'; }
    }
    async function updateDashboard() {
      try {
        const values = $("#yearSlider").slider("values");
        const yearRangeParam = values.join(":");
        const [startYear, endYear] = yearRangeParam.split(":");
        updateThresholdControlsVisibility(startYear, endYear);
        const selected = window.selectedCountries || [];
        let expandedSelected = new Set();
        if (window.countryOptions) {
          window.countryOptions.forEach(regionOption => {
            if (selected.includes(regionOption.id)) {
              regionOption.children.forEach(child => expandedSelected.add(child.id));
            }
          });
        }
        selected.forEach(sel => {
          if (!window.countryOptions || !window.countryOptions.find(opt => opt.id === sel))
            expandedSelected.add(sel);
        });
        window.filteredCountries = expandedSelected;
        const rawDataRange = await fetchGDPData(yearRangeParam, mainIndicator);
        const rawDataEnd = await fetchGDPData(`${endYear}:${endYear}`, mainIndicator);
        let processedRange = processGDPData(rawDataRange, startYear, endYear);
        let processedEnd = processGDPData(rawDataEnd, endYear, endYear);
        const endYearLookup = {};
        processedEnd.forEach(d => { endYearLookup[d.country] = d.endValue; });
        processedRange.forEach(d => { if (endYearLookup[d.country] !== undefined) d.endValue = endYearLookup[d.country]; });
        if (window.filteredCountries.size > 0) {
          processedRange = processedRange.filter(d => window.filteredCountries.has(d.country));
        }
        renderBarChartD3(processedRange, yearRangeParam, mainIndicator, document.getElementById("barChartContent"));
        if (worldGeoJSON) {
          const mapData = processMapData(rawDataRange, startYear, endYear);
          window.currentGdpLookup = mapData;
          updateD3MapChart(mapData, yearRangeParam, mainIndicator, mainIndicatorName);
        }
        document.querySelectorAll('.additional-group').forEach(group => { updateAdditionalGroup(group); });
      } catch (error) { console.error("Dashboard update failed:", error); }
    }
    window.updateDashboard = updateDashboard;
    function updateD3MapChart(gdpLookup, year, indicator, indicatorName) {
      const svg = d3.select("#d3Map");
      svg.selectAll("*").remove();
      const width = +svg.attr("width");
      const height = +svg.attr("height");
      const years = year.split(":");
      const isSingleYear = (years[0] === years[1]);

      svg.append("text")
        .attr("class", "chart-headline")
        .attr("x", width / 2)
        .attr("y", -60)
        .attr("text-anchor", "middle")
        .style("fill", "var(--color-text)")
        .style("font-size", "30px")
        .style("font-weight", "bold")
        .text(years[1] + " | " + indicatorName);

      const projection = d3.geoMercator().fitSize([width, height], worldGeoJSON);
      const path = d3.geoPath().projection(projection);
      const g = svg.append("g").attr("transform", "translate(0,30)");

      const valueFormatter = getValueFormatter(indicator);
      // Definiere hier den Formatter für die Legende: Bei mehreren Jahren als Prozent formatiert, sonst wie gewohnt
      const legendFormatter = isSingleYear ? valueFormatter : d => `${d}%`;

      const filteredCountries = window.filteredCountries || new Set();
      g.selectAll("path")
        .data(worldGeoJSON.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", d => {
          if (filteredCountries.size > 0 && !filteredCountries.has(d.properties.name))
            return "transparent";
          const isoCode = d.properties.iso_a3 || d.id;
          const value = gdpLookup[isoCode] || 0;
          return isSingleYear
            ? (value > 0 ? getUserDefinedColorScale(d3.min(Object.values(gdpLookup)), d3.max(Object.values(gdpLookup)))(value) : "#444")
            : thresholdColor(value);
        })
        .attr("stroke", "#666")
        .attr("stroke-width", 0.5)
        .on("click", (event, d) => {
          const isoCode = d.properties.iso_a3 || d.id;
          window.location.href = "countries?country=" + isoCode;
        })
        .on("mouseover", function (event, d) {
          d3.select(this).attr("stroke-width", 2);
          d3.select("#tooltip")
            .style("display", "block")
            .html(`<strong>${d.properties.name}</strong><br>${indicatorName}: ${valueFormatter(gdpLookup[d.properties.iso_a3 || d.id] || 0)}<br>Click for deep dive`);
        })
        .on("mousemove", function (event) {
          d3.select("#tooltip")
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px");
        })
        .on("mouseout", function () {
          d3.select(this).attr("stroke-width", 0.5);
          d3.select("#tooltip").style("display", "none");
        });

      const legendWidth = 200, legendHeight = 10;
      const legendX = width - legendWidth - 20, legendY = height - 40;
      const defs = svg.append("defs");
      const gradient = defs.append("linearGradient")
        .attr("id", "legend-gradient")
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "100%")
        .attr("y2", "0%");
      if (isSingleYear) {
        gradient.append("stop").attr("offset", "0%").attr("stop-color", "lightblue");
        gradient.append("stop").attr("offset", "100%").attr("stop-color", "darkblue");
      } else {
        gradient.append("stop")
          .attr("offset", "0%")
          .attr("stop-color", "var(--color-secondary)");
        gradient.append("stop")
          .attr("offset", "50%")
          .attr("stop-color", "var(--color-primary)");
        gradient.append("stop")
          .attr("offset", "100%")
          .attr("stop-color", "var(--color-tertiary)");
      }
      svg.append("rect")
        .attr("x", legendX)
        .attr("y", legendY)
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .style("fill", "url(#legend-gradient)")
        .style("stroke", "#666")
        .style("stroke-width", 0.5);

      // Hier werden die Grenzen der Legende gesetzt:
      const lowVal = isSingleYear ? 0 : +document.getElementById('blueThreshold').value;
      const highVal = isSingleYear ? 1e5 : +document.getElementById('redThreshold').value;
      svg.append("text")
        .attr("x", legendX)
        .attr("y", legendY - 5)
        .attr("text-anchor", "start")
        .style("font-size", "12px")
        .style("fill", "var(--color-text)")
        .text(legendFormatter(lowVal));
      svg.append("text")
        .attr("x", legendX + legendWidth)
        .attr("y", legendY - 5)
        .attr("text-anchor", "end")
        .style("font-size", "12px")
        .style("fill", "var(--color-text)")
        .text(legendFormatter(highVal));

      const zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", event => { g.attr("transform", event.transform); });
      const initialTransform = d3.zoomIdentity.translate(-250, 0).scale(1.5);
      svg.call(zoom).call(zoom.transform, initialTransform);
    }
    // --- State persistence functions ---
    function saveState() {
      const yearRange = $("#yearSlider").slider("values");
      const mainIndicatorVal = mainIndicatorSelect.value;
      const selectedCountries = window.selectedCountriesRaw;
      const additionalGroupsState = Array.from(document.querySelectorAll('.additional-group')).map(group => {
        const indicator = group._indicator;
        const indicatorName = group._indicatorName;
        const additionalRedThreshold = group.querySelector('.additionalRedThreshold') ? group.querySelector('.additionalRedThreshold').value : null;
        const additionalBlueThreshold = group.querySelector('.additionalBlueThreshold') ? group.querySelector('.additionalBlueThreshold').value : null;
        return { indicator, indicatorName, additionalRedThreshold, additionalBlueThreshold };
      });

      // Save current theme colors
      const themeColors = {};
      for (const inputId in colorMapping) {
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
          themeColors[inputId] = inputEl.value;
        }
      }

      const state = { yearRange, mainIndicatorVal, selectedCountries, additionalGroupsState, themeColors };
      localStorage.setItem('dashboardState', JSON.stringify(state));
    }

    function loadState() {
      const stateStr = localStorage.getItem('dashboardState');
      if (!stateStr) return;
      const state = JSON.parse(stateStr);

      if (state.yearRange) {
        $("#yearSlider").slider("values", state.yearRange);
        $("#yearRangeDisplay").text(state.yearRange[0] + " - " + state.yearRange[1]);
      }

      if (state.mainIndicatorVal) {
        mainIndicatorSelect.value = state.mainIndicatorVal;
        mainIndicator = state.mainIndicatorVal;
        mainIndicatorName = mainIndicatorSelect.options[mainIndicatorSelect.selectedIndex].textContent;
      }

      if (state.selectedCountries) {
        window.selectedCountriesRaw = state.selectedCountries;
        if (window.vueCountrySelectVm) {
          window.vueCountrySelectVm.selectedCountries = state.selectedCountries;
        }
      }

      if (state.additionalGroupsState && Array.isArray(state.additionalGroupsState)) {
        const container = document.getElementById("additionalGroupsContainer");
        container.innerHTML = "";
        state.additionalGroupsState.forEach(groupState => {
          const newGroup = createAdditionalGroup(groupState.indicator, groupState.indicatorName);
          const redInput = newGroup.querySelector('.additionalRedThreshold');
          const blueInput = newGroup.querySelector('.additionalBlueThreshold');
          if (redInput && groupState.additionalRedThreshold) redInput.value = groupState.additionalRedThreshold;
          if (blueInput && groupState.additionalBlueThreshold) blueInput.value = groupState.additionalBlueThreshold;
          container.appendChild(newGroup);
          updateAdditionalGroup(newGroup);
        });
      }

      // Restore theme colors if available
      if (state.themeColors) {
        for (const inputId in state.themeColors) {
          const inputEl = document.getElementById(inputId);
          if (inputEl) {
            inputEl.value = state.themeColors[inputId];
          }
        }
        updateColorVariables();
      }
    }
    // --- End state persistence functions ---
  </script>
  <script>

    function loadTranslations(language) {
      fetch('./' + language + '.json')
        .then(response => response.json())
        .then(translations => {
          document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[key]) {
              // Falls ein Kind mit der Klasse "translation" existiert, nur dessen Inhalt ersetzen.
              const translationChild = element.querySelector('.translation');
              if (translationChild) {
                translationChild.textContent = translations[key];
              } else {
                element.textContent = translations[key];
              }
            }
          });
        })
        .catch(error => console.error('Error loading translations:', error));
    }
  </script>
  <script>
    // Load saved state on page load
    document.addEventListener("DOMContentLoaded", () => { loadState(); });

    document.addEventListener("DOMContentLoaded", () => {
      loadTranslations("en"); // Standardmäßig Englisch laden
    });

    document.getElementById('languageSelector').addEventListener('change', function (e) {
      loadTranslations(e.target.value);
    });
  </script>
  <script>
    $(document).ready(function () {
      function formatState(state) {
        if (!state.id) {
          return state.text;
        }
        var flagCode = $(state.element).data('flag');
        var flagUrl = "https://flagcdn.com/w20/" + flagCode.toLowerCase() + ".png";
        return $('<span><img crossorigin="anonymous" src="' + flagUrl + '" style="width:20px; margin-right:8px;" />' + state.text + '</span>');
      }

      $('#languageSelector').select2({
        templateResult: formatState,
        templateSelection: formatState,
        minimumResultsForSearch: Infinity,
        width: '120px'
      });

      // Neu: Hänge den Change-Listener an das Select2-Element
      $('#languageSelector').on('change', function (e) {
        loadTranslations($(this).val());
      });
    });

    //Select Saved Dashboards
    $(document).ready(function () {
      $('#savedDashboardsSelect').select2({
        placeholder: "Select Saved Dashboard",
        minimumResultsForSearch: Infinity,
        width: '200px' // Adjust width if needed
      });
    });

    document.getElementById('saveStateBtn').addEventListener('click', function () {
      saveState();
      alert("State saved successfully!");
    });
  </script>
  <script>
    // Öffnen des User Info Modals beim Klick auf das Account-Icon
    document.getElementById('accountIcon').addEventListener('click', function () {
      document.getElementById('userInfoModal').style.display = 'block';
    });

    // Schließen des User Info Modals
    document.getElementById('closeUserInfoModal').addEventListener('click', function () {
      document.getElementById('userInfoModal').style.display = 'none';
    });

    document.getElementById('saveColorsButton').addEventListener('click', function () {
      document.getElementById('colorModal').style.display = 'none';
    });

    // Öffnen des Color Pickers, indem zuerst das User Info Modal geschlossen wird
    document.getElementById('openColorPicker').addEventListener('click', function () {
      document.getElementById('userInfoModal').style.display = 'none';
      document.getElementById('colorModal').style.display = 'block';
    });

    // Schließen des Color Modals
    document.getElementById('closeColorModal').addEventListener('click', function () {
      document.getElementById('colorModal').style.display = 'none';
    });

    // Light/Dark Mode Toggle
    document.getElementById('modeToggle').addEventListener('change', function () {
      if (this.checked) {
        // Light Mode: setze alternative helle Farbwerte
        document.documentElement.style.setProperty('--color-bg', '#FFFFFF');
        document.documentElement.style.setProperty('--color-bg-light', '#F5F5F5');
        document.documentElement.style.setProperty('--color-bg-medium', '#E0E0E0');
        document.documentElement.style.setProperty('--color-bg-dark', '#CCCCCC');
        document.documentElement.style.setProperty('--color-text', '#fdf0d5');
        document.documentElement.style.setProperty('--vue-color', '#FFFFFF');
      } else {
        // Dark Mode: setze die ursprünglichen dunklen Farbwerte
        document.documentElement.style.setProperty('--color-bg', '#1a1a1a');
        document.documentElement.style.setProperty('--color-bg-light', '#1a1a1a');
        document.documentElement.style.setProperty('--color-bg-medium', '#333333');
        document.documentElement.style.setProperty('--color-bg-dark', '#1a1a1a');
        document.documentElement.style.setProperty('--color-primary', '#DB7C26');
        document.documentElement.style.setProperty('--color-secondary', '#C1121F');
        document.documentElement.style.setProperty('--color-tertiary', '#669BBC');
        document.documentElement.style.setProperty('--color-accent', '#228B22');
        document.documentElement.style.setProperty('--color-text', '#fdf0d5');
        document.documentElement.style.setProperty('--vue-color', '#fdf0d5');
        document.documentElement.style.setProperty('--color-border', 'rgba(255, 255, 255, 0.1)');
        document.documentElement.style.setProperty('--color-shadow', 'rgba(0, 0, 0, 0.7)');
      }
    });
  </script>
  <script>
    // Mapping from input IDs to CSS variable names
    const colorMapping = {
      "q1Color": "--color-secondary",
      "q2Color": "--color-primary",
      "q3Color": "--color-tertiary",
      "color-bg": "--color-bg",
      "color-bg-light": "--color-bg-light",
      "color-bg-medium": "--color-bg-medium",
      "color-bg-dark": "--color-bg-dark",
      "color-text": "--color-text"
    };

    function updateColorVariables() {
      for (const inputId in colorMapping) {
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
          document.documentElement.style.setProperty(colorMapping[inputId], inputEl.value);
        }
      }
    }

    // Immediately update CSS variables when the color inputs change
    for (const inputId in colorMapping) {
      const inputEl = document.getElementById(inputId);
      if (inputEl) {
        inputEl.addEventListener("input", updateColorVariables);
      }
    }

    // Also update on page load in case values are already set
    document.addEventListener("DOMContentLoaded", updateColorVariables);
  </script>
  <script>
    // Diese Funktion holt ein externes Bild per fetch und wandelt es in einen Base64-DataURL um.
    async function getBase64Image(url) {
      try {
        const response = await fetch(url, { mode: "cors", cache: "no-cache" });
        if (!response.ok) {
          console.error("Fetch failed:", response.status, response.statusText);
          return null;
        }
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            console.log("Base64 conversion successful");
            resolve(reader.result);
          };
          reader.onerror = (error) => {
            console.error("FileReader error:", error);
            reject(error);
          };
          reader.readAsDataURL(blob);
        });
      } catch (error) {
        console.error("Error fetching image:", error);
        return null;
      }
    }

    // Diese Funktion erstellt einen neuen Slide in der Präsentation und fügt dort ein Bild (übergeben als URL) ein.
    async function createPresentationSlideWithImage(pres, imageUrl, slideTitle, x, y, w, h, textColor) {
      const base64Image = await getBase64Image(imageUrl);
      if (base64Image) {
        let slide = pres.addSlide({ masterName: "MASTER_SLIDE" });
        slide.addText(slideTitle, {
          x: 0.3,
          y: 0.25,
          w: 9,
          fontSize: 24,
          bold: true,
          color: textColor
        });
        slide.addImage({
          data: base64Image,
          x: x,
          y: y,
          w: w,
          h: h
        });
      } else {
        console.error("Das Bild konnte nicht in Base64 konvertiert werden.");
      }
    }

    async function createPresentation() {
      // Helper-Funktion: Umrechnung von Pixel in Zoll (1 Zoll ≈ 96 Pixel)
      function pxToInches(px) {
        return px / 96;
      }

      // Erstelle eine neue Präsentation
      let pres = new PptxGenJS();

      // Lese aktuelle CSS-Variablen für Theme-Farben aus
      const computedStyle = getComputedStyle(document.documentElement);
      const bgColor = computedStyle.getPropertyValue('--color-bg').trim().replace('#', '');
      const bgLight = computedStyle.getPropertyValue('--color-bg-light').trim().replace('#', '');
      const textColor = computedStyle.getPropertyValue('--color-text').trim().replace('#', '');

      // Definiere einen Master-Slide mit den Theme-Farben
      pres.defineSlideMaster({
        title: "MASTER_SLIDE",
        background: { fill: bgColor },
        objects: [
          { rect: { x: 0, y: 0, w: "100%", h: 0.6, fill: { color: bgLight } } },
          { rect: { x: 0, y: "7.0", w: "100%", h: 0.4, fill: { color: bgLight } } }
        ],
        slideNumber: { x: 9.0, y: "7.1", color: textColor }
      });

      // Erstelle einen Titel-Slide
      let titleSlide = pres.addSlide({ masterName: "MASTER_SLIDE" });
      titleSlide.addText("SIQ Company Economy Dashboard", {
        x: 0.3,
        y: 0.25,
        w: 9,
        fontSize: 32,
        bold: true,
        color: textColor
      });
      titleSlide.addText("A Professional Overview of All Available Charts", {
        x: 0.3,
        y: 1,
        w: 9,
        fontSize: 20,
        color: textColor
      });

      // Hole alle Diagramm-Elemente, die in die Präsentation aufgenommen werden sollen.
      // Passe die Selektoren (".chart-container, .additional-chart") bei Bedarf an.
      const chartElements = document.querySelectorAll(".chart-container, .additional-chart");

      // Schleife über alle Diagramm-Elemente: Mit html2canvas wird jedes Diagramm als Bild erfasst.
      for (const chartEl of chartElements) {
        try {
          // Erzeuge ein Canvas des Diagramm-Elements; erhöhe die Auflösung mit scale.
          const canvas = await html2canvas(chartEl, {
            scale: window.devicePixelRatio * 2,
            useCORS: true,
            allowTaint: false,
            backgroundColor: null
          });
          const imageData = canvas.toDataURL("image/png");

          // Optionale Überschrift aus einem data-Attribut; ansonsten Standardtitel.
          const chartTitle = chartEl.getAttribute("data-chart-title") || "Chart Slide";

          // Erstelle einen neuen Slide für dieses Diagramm.
          let slide = pres.addSlide({ masterName: "MASTER_SLIDE" });
          slide.addText(chartTitle, {
            x: 0.3,
            y: 0.25,
            w: 9,
            fontSize: 24,
            bold: true,
            color: textColor
          });

          // Füge das erstellte Bild dem Slide hinzu (hier als Beispiel mit fester Position und Größe)
          slide.addImage({
            data: imageData,
            x: 1.0,
            y: 1.0,
            w: 5,  // Beispiel: reduzierte Breite
            h: 3   // Beispiel: reduzierte Höhe
          });
        } catch (err) {
          console.error("Error capturing chart:", err);
        }
      }

      // Schreibe die Präsentation – die Datei wird automatisch heruntergeladen.
      pres.writeFile({ fileName: "SIQ_Company_Economy_Presentation.pptx" });
    }

    // Binde die createPresentation-Funktion an den "Create Presentation"-Button.
    document.getElementById("createPresentation").addEventListener("click", createPresentation);
  </script>

</body>

</html>
