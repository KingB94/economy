<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Explorer</title>

  <!-- Google Fonts for header -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />

  <!-- Select2 for enhanced dropdowns (we keep KPI select as Select2) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <!-- noUiSlider CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" />

  <!-- Vue Treeselect CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@riophae/vue-treeselect@0.4.0/dist/vue-treeselect.min.css">

  <style>
    /* ---------- Global Styles & Reset ---------- */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #121212;
      /* Add top padding to account for the fixed header */
      padding-top: 60px;
      color: #e0e0e0;
    }

    /* ---------- Fixed Header ---------- */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, #1f1f1f, #323232);
      color: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1100;
    }

    .burger-icon {
      font-size: 24px;
      cursor: pointer;
      margin-right: 10px;
      color: #e0e0e0;
    }

    /* ---------- Navigation Sidebar ---------- */
    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background-color: #1f1f1f;
      color: #e0e0e0;
      padding-top: 60px;
      transition: left 0.3s ease;
      z-index: 1200;
      font-family: 'Roboto', sans-serif;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar .close-sidebar {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #e0e0e0;
    }

    .sidebar .main-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar .main-nav ul li {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar .main-nav ul li a {
      text-decoration: none;
      color: #e0e0e0;
      font-weight: 500;
      display: block;
    }

    .sidebar .main-nav ul li a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    /* ---------- Overlay for Sidebar ---------- */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1150;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    /* ---------- Main Container ---------- */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-item {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
    }

    .filter-item label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #e0e0e0;
      font-size: 0.9em;
    }

    #yearRangeDisplay {
      margin-top: 5px;
      font-size: 0.9em;
      color: #ccc;
    }

    /* For the displayed selected text in Select2 */
    .select2-container--default .select2-selection--single .select2-selection__rendered,
    .select2-container--default .select2-selection--multiple .select2-selection__rendered {
      color: #000;
    }

    /* For the selection box itself in Select2 */
    .select2-container--default .select2-selection--single,
    .select2-container--default .select2-selection--multiple {
      background-color: #fff;
      border: 1px solid #ccc;
      color: #000;
    }

    /* For the dropdown options in Select2 */
    .select2-container--default .select2-results__option {
      color: #000;
      background-color: #fff;
    }

    /* For the highlighted option in Select2 */
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #ddd;
      color: #000;
    }

    button {
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: #1f1f1f;
      color: #e0e0e0;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #323232;
    }

    /* ---------- Table & Pagination ---------- */
    .table-container {
      margin-top: 20px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }

    th,
    td {
      padding: 8px;
      border: 1px solid #333;
      text-align: left;
      font-size: 0.9em;
      line-height: 1.5;
      vertical-align: middle;
    }

    th {
      background-color: #2c2c2c;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .pagination.hidden {
      display: none;
    }

    .download-buttons {
      margin-top: 10px;
    }

    /* Override Vue Treeselect text color to black for the input, placeholders, etc. */
    .vue-treeselect__control,
    .vue-treeselect__single-value,
    .vue-treeselect__placeholder,
    .vue-treeselect__multi-value-item,
    .vue-treeselect__option,
    .vue-treeselect__label {
      color: black !important;
    }

    .vue-treeselect__value-remove {
      color: black !important;
    }

    /* ---------- Fix the height and wrapping for Treeselect ---------- */

    /* Force a fixed height on the control */
    .vue-treeselect__control {
      height: 36px !important;
      max-height: 36px !important;
      overflow: hidden !important;
    }

    /* Prevent wrapping of selected items and allow horizontal scroll */
    .vue-treeselect__multi-value-wrapper {
      display: inline-flex !important;
      flex-wrap: nowrap !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      white-space: nowrap !important;
      align-items: center !important;
      max-height: 36px !important;
    }

    /* Ensure each selected item is on a single line */
    .vue-treeselect__multi-value-item {
      white-space: nowrap !important;
      flex: 0 0 auto !important;
    }

    .vue-treeselect--searchable:not(.vue-treeselect--disabled) .vue-treeselect__value-container {
      cursor: text;
      max-height: 50px;
      overflow-y: auto;
    }

    .vue-treeselect--has-value .vue-treeselect__multi-value {
      margin-bottom: 5px;
      height: 25px;
    }
  </style>

  <!-- PptxGenJS (loaded with defer so itâ€™s ready by the time our script runs) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.15.0/pptxgen.bundle.js"></script>

  <!-- Vue 2 and Vue Treeselect JS -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@riophae/vue-treeselect@0.4.0/dist/vue-treeselect.umd.min.js"></script>
</head>

<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <span class="close-sidebar" id="closeSidebar">&times;</span>
    <nav class="main-nav">
      <ul>
        <li><a href="comparative.html">Comparative View</a></li>
        <li><a href="data.html">Data</a></li>
      </ul>
    </nav>
  </div>
  <!-- Overlay for Sidebar -->
  <div class="overlay" id="overlay"></div>

  <!-- Fixed Header -->
  <header>
    <div class="header-left">
      <span class="burger-icon" id="burgerIcon">&#9776;</span>
    </div>
    <h1>Data Explorer</h1>
    <div style="width:24px;"></div>
  </header>

  <div class="container">
    <h2>Data Explorer</h2>
    <div class="filters">
      <!-- Vue Treeselect replaces the old countrySelect -->
      <div id="vueCountrySelectContainer" class="filter-item">
        <label class="filter-label">Select Countries:</label>
        <treeselect v-model="selectedCountries" :options="countryOptions" :multiple="true"
          placeholder="Select countries" />
      </div>
      <div class="filter-item">
        <label for="kpiSelect">Select KPIs:</label>
        <select id="kpiSelect" multiple style="width:100%"></select>
      </div>
      <div class="filter-item">
        <label for="yearRangeSlider">Select Year Range:</label>
        <div id="yearRangeSlider"></div>
        <p id="yearRangeDisplay">Selected Years: 2000 - 2020</p>
      </div>
      <div class="filter-item" style="align-self: flex-end;">
        <button id="loadDataBtn">Load Data</button>
      </div>
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead></thead>
        <tbody></tbody>
      </table>
      <div class="pagination hidden" id="paginationControls">
        <button id="prevPageBtn">Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPageBtn">Next</button>
      </div>
      <div class="download-buttons">
        <button id="downloadData">Download Data</button>
        <button id="createPresentation">Create Presentation</button>
      </div>
    </div>
  </div>

  <!-- ---------- JS Libraries ---------- -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Our custom script executes after all libraries have loaded -->
  <script>
    window.addEventListener('load', () => {
      // Sidebar toggle functionality
      const burgerIcon = document.getElementById('burgerIcon');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      const closeSidebar = document.getElementById('closeSidebar');

      burgerIcon.addEventListener('click', () => {
        sidebar.classList.add('active');
        overlay.classList.add('active');
      });
      closeSidebar.addEventListener('click', () => {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
      });
      overlay.addEventListener('click', () => {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
      });

      // Initialize Select2 only for KPI select
      $(document).ready(function () {
        $("#kpiSelect").select2({ placeholder: "Select KPIs" });
      });

      // Populate KPI select from static kpis list
      const kpis = [
        { id: "NY.GDP.MKTP.CD", name: "GDP (Current US$)" },
        { id: "NY.GDP.PCAP.CD", name: "GDP per Capita (Current US$)" },
        { id: "SL.UEM.TOTL.ZS", name: "Unemployment (% of labor force)" },
        { id: "FP.CPI.TOTL.ZG", name: "Inflation (annual %)" }
      ];
      kpis.forEach(kpi => {
        const option = new Option(kpi.name, kpi.id, false, false);
        $("#kpiSelect").append(option);
      });
      $("#kpiSelect").trigger("change");

      // Initialize noUiSlider for year range
      const yearSlider = document.getElementById('yearRangeSlider');
      noUiSlider.create(yearSlider, {
        start: [2000, 2020],
        connect: true,
        step: 1,
        range: { min: 1960, max: 2023 },
        tooltips: false,
        format: {
          to: value => Math.round(value),
          from: value => Number(value)
        }
      });
      yearSlider.noUiSlider.on('update', function (values) {
        document.getElementById("yearRangeDisplay").textContent = "Selected Years: " + values[0] + " - " + values[1];
      });

      // Global variables for table pagination
      let fullData = [];
      let currentPage = 1;
      const rowsPerPage = 50;

      document.getElementById("loadDataBtn").addEventListener("click", loadData);

      // In loadData, we use window.selectedCountries (set by Vue Treeselect).
      // We expand the selection: if a region is selected, all countries in that region are included.
      async function loadData() {
        const selected = window.selectedCountries || [];
        // Build expanded list of country codes.
        // Here we assume window.countriesInfo is available.
        const expandedCountries = new Set();
        if (window.countriesInfo) {
          // Create a lookup: region -> array of country ids
          const regionLookup = {};
          window.countriesInfo.forEach(country => {
            let region = country.region.value.trim() || "Other";
            if (!regionLookup[region]) {
              regionLookup[region] = [];
            }
            // Use country.id as the unique code.
            regionLookup[region].push(country.id);
          });
          // For each selected value:
          selected.forEach(sel => {
            // If the selection matches a region key, add all country ids in that region;
            // otherwise, assume it is already a country code.
            if (regionLookup[sel]) {
              regionLookup[sel].forEach(code => expandedCountries.add(code));
            } else {
              expandedCountries.add(sel);
            }
          });
        }

        const selectedKpis = $("#kpiSelect").val();
        const yrRange = yearSlider.noUiSlider.get().map(Number);

        if (!selectedKpis || expandedCountries.size === 0 || selectedKpis.length === 0) {
          alert("Please select at least one country and one KPI.");
          return;
        }

        fullData = [];

        // For each expanded country code, fetch data for each KPI and merge by year.
        for (const country of expandedCountries) {
          let countryData = {};
          for (const kpi of selectedKpis) {
            const data = await fetchTimeSeriesData(country, kpi);
            const filtered = data.years.map((yr, idx) => ({
              year: parseInt(yr),
              value: data.values[idx]
            })).filter(item => item.year >= yrRange[0] && item.year <= yrRange[1]);
            countryData[kpi] = filtered;
          }

          // Create union of all years for this country.
          let yearsSet = new Set();
          selectedKpis.forEach(kpi => {
            countryData[kpi].forEach(item => yearsSet.add(item.year));
          });
          let yearsArray = Array.from(yearsSet).sort((a, b) => a - b);

          // For each year, create a row with country code and year.
          for (const yr of yearsArray) {
            const row = { country: country, year: yr };
            selectedKpis.forEach(kpi => {
              const val = countryData[kpi].find(item => item.year === yr);
              row[kpi] = val ? val.value : "";
            });
            fullData.push(row);
          }
        }

        // Sort by country, then year
        fullData.sort((a, b) => a.country.localeCompare(b.country) || a.year - b.year);

        currentPage = 1;
        renderTable();
        document.getElementById("paginationControls").classList.remove("hidden");
      }

      async function fetchTimeSeriesData(country, indicator) {
        const url = `https://api.worldbank.org/v2/country/${country}/indicator/${indicator}?format=json&per_page=1000`;
        try {
          const response = await fetch(url);
          const json = await response.json();
          if (!json || json.length < 2) return { years: [], values: [] };

          // Filter out data points with no value
          const data = json[1].filter(d => d.value !== null);
          // Sort ascending by year
          data.sort((a, b) => parseInt(a.date) - parseInt(b.date));

          const years = data.map(d => d.date);
          const values = data.map(d => d.value);
          return { years, values };
        } catch (error) {
          console.error("Error fetching data for", indicator, error);
          return { years: [], values: [] };
        }
      }

      function renderTable() {
        const tableHead = document.querySelector("#dataTable thead");
        const tableBody = document.querySelector("#dataTable tbody");

        tableHead.innerHTML = "";
        tableBody.innerHTML = "";

        const selectedKpis = $("#kpiSelect").val();
        const headerRow = document.createElement("tr");
        const headers = ["Country", "Year"].concat(selectedKpis.map(kpiId => {
          const obj = kpis.find(item => item.id === kpiId);
          return obj ? obj.name : kpiId;
        }));

        headers.forEach(text => {
          const th = document.createElement("th");
          th.textContent = text;
          headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        const startIndex = (currentPage - 1) * rowsPerPage;
        const paginatedData = fullData.slice(startIndex, startIndex + rowsPerPage);

        paginatedData.forEach(row => {
          const tr = document.createElement("tr");
          const tdCountry = document.createElement("td");
          tdCountry.textContent = row.country;
          tr.appendChild(tdCountry);

          const tdYear = document.createElement("td");
          tdYear.textContent = row.year;
          tr.appendChild(tdYear);

          selectedKpis.forEach(kpi => {
            const td = document.createElement("td");
            td.textContent = row[kpi];
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });

        const pageInfo = document.getElementById("pageInfo");
        pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(fullData.length / rowsPerPage)}`;
      }

      document.getElementById("prevPageBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });

      document.getElementById("nextPageBtn").addEventListener("click", () => {
        if (currentPage < Math.ceil(fullData.length / rowsPerPage)) {
          currentPage++;
          renderTable();
        }
      });

      document.getElementById("downloadData").addEventListener("click", () => {
        const format = prompt("Enter the format to download (csv, txt, json):", "csv");
        if (format) {
          downloadData(format.toLowerCase());
        }
      });

      function downloadData(format) {
        let dataStr = "";
        const selectedKpis = $("#kpiSelect").val();
        const headers = ["Country", "Year"].concat(selectedKpis.map(kpiId => {
          const obj = kpis.find(item => item.id === kpiId);
          return obj ? obj.name : kpiId;
        }));

        // Build string in selected format
        if (format === "csv") {
          dataStr += headers.join(",") + "\n";
          fullData.forEach(row => {
            let rowArr = [row.country, row.year];
            selectedKpis.forEach(kpi => {
              rowArr.push(row[kpi] !== "" ? row[kpi] : "");
            });
            dataStr += rowArr.join(",") + "\n";
          });
        } else if (format === "txt") {
          dataStr += headers.join("\t") + "\n";
          fullData.forEach(row => {
            let rowArr = [row.country, row.year];
            selectedKpis.forEach(kpi => {
              rowArr.push(row[kpi] !== "" ? row[kpi] : "");
            });
            dataStr += rowArr.join("\t") + "\n";
          });
        } else if (format === "json") {
          dataStr = JSON.stringify(fullData, null, 2);
        } else {
          alert("Unsupported format. Please choose csv, txt, or json.");
          return;
        }

        // Download the file
        const blob = new Blob([dataStr], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `data.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      document.getElementById("createPresentation").addEventListener("click", createPresentation);

      async function createPresentation() {
        if (fullData.length === 0) {
          alert("No data available. Please load data first.");
          return;
        }
        const selectedKpis = $("#kpiSelect").val();
        if (!selectedKpis || selectedKpis.length === 0) {
          alert("Please select at least one KPI.");
          return;
        }
        // Ensure PptxGenJS is available
        if (typeof PptxGenJS === "undefined") {
          alert("PptxGenJS library failed to load.");
          return;
        }

        let pres = new PptxGenJS();

        for (let kpi of selectedKpis) {
          let yearsSet = new Set();
          fullData.forEach(row => {
            if (row[kpi] !== "") yearsSet.add(row.year);
          });
          let years = Array.from(yearsSet).sort((a, b) => a - b);

          let datasets = [];
          const countries = [...new Set(fullData.map(row => row.country))];
          for (let country of countries) {
            let countryData = fullData.filter(row => row.country === country && row[kpi] !== "");
            let dataMap = {};
            countryData.forEach(row => { dataMap[row.year] = row[kpi]; });
            let dataArr = years.map(yr => dataMap[yr] || null);
            datasets.push({
              label: country,
              data: dataArr,
              borderColor: getRandomColor(),
              fill: false
            });
          }

          // Create an off-screen canvas to draw the chart
          let canvas = document.createElement('canvas');
          canvas.width = 800;
          canvas.height = 600;
          canvas.style.display = "none";
          document.body.appendChild(canvas);

          let ctx = canvas.getContext('2d');
          let chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: years,
              datasets: datasets
            },
            options: {
              responsive: false,
              plugins: {
                title: {
                  display: true,
                  text: (kpis.find(item => item.id === kpi) || { name: kpi }).name
                }
              }
            }
          });

          // Wait a bit to ensure chart is drawn
          await new Promise(resolve => setTimeout(resolve, 500));

          // Convert chart to data URL
          let chartDataURL = canvas.toDataURL('image/png');
          document.body.removeChild(canvas);

          // Add a new slide with the chart image
          let slide = pres.addSlide();
          slide.addImage({ data: chartDataURL, x: 1, y: 1, w: 8, h: 5 });
          slide.addText((kpis.find(item => item.id === kpi) || { name: kpi }).name, {
            x: 1, y: 0.2, fontSize: 24, color: '363636'
          });
        }

        // Save the PowerPoint file
        pres.writeFile({ fileName: "presentation.pptx" });
      }

      function getRandomColor() {
        let letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }
    });
  </script>

  <!-- Vue Treeselect Instance for Country Selection -->
  <script>
    Vue.component('treeselect', VueTreeselect.Treeselect);
    new Vue({
      el: '#vueCountrySelectContainer',
      data: {
        selectedCountries: [],
        countryOptions: []
      },
      watch: {
        selectedCountries(newVal) {
          // Write the selection globally so loadData() can use it.
          window.selectedCountries = newVal;
        }
      },
      created() {
        // Wait until countriesInfo is loaded.
        if (window.countriesInfo) {
          this.buildOptions();
        } else {
          const interval = setInterval(() => {
            if (window.countriesInfo) {
              clearInterval(interval);
              this.buildOptions();
            }
          }, 100);
        }
      },
      methods: {
        buildOptions() {
          // Build options grouped by region.
          const regionsMap = {};
          window.countriesInfo.forEach(country => {
            let region = country.region.value.trim() || "Other";
            if (!regionsMap[region]) {
              regionsMap[region] = [];
            }
            // Use country.id as value so that API calls work correctly.
            regionsMap[region].push({
              id: country.id,
              label: country.name
            });
          });
          this.countryOptions = Object.keys(regionsMap).map(region => ({
            id: region,
            label: region,
            children: regionsMap[region]
          }));
          // Optionally, clear or set a default selection
          this.selectedCountries = [];
          window.selectedCountries = this.selectedCountries;
        }
      }
    });
  </script>

  <!-- Load countries.json and assign to global variable -->
  <script>
    fetch("countries.json")
      .then(response => response.json())
      .then(data => {
        window.countriesInfo = data;
      })
      .catch(error => { console.error("Error loading countries.json:", error); });
  </script>
</body>

</html>
